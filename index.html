<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¶³è¿¹ - åœ¨çº¿ç‰ˆ</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- å¼•å…¥ jQuery -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- å¼•å…¥ Supabase SDK (æ ¸å¿ƒ) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- 1. å…¨å±€ä¸èƒŒæ™¯ --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1b2735 0%, #090a0f 100%);
            color: #fff;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: transparent;
            /* ä½¿ç”¨æ›´æ¸…æ™°çš„å•ä¸ªåœ†ç‚¹å®šä¹‰ï¼Œè°ƒæ•´äº†åæ ‡åˆ†å¸ƒ */
            background-image:
            /* ç¬¬ä¸€ç»„ï¼šç¨å¤§çš„äº®æ˜Ÿ */
            radial-gradient(2px 2px at 50px 100px, #ffffff, transparent), 
                radial-gradient(2px 2px at 350px 50px, #ffffff, transparent), 
                radial-gradient(2px 2px at 550px 500px, #ffffff, transparent), 
                radial-gradient(2px 2px at 150px 450px, #ffffff, transparent), 
                radial-gradient(2px 2px at 400px 300px, #ffffff, transparent),
            /* ç¬¬äºŒç»„ï¼šå¾®å¼±çš„å°æ˜Ÿ (å¢åŠ å±‚æ¬¡æ„Ÿ) */
            radial-gradient(1px 1px at 200px 200px, rgba(255,255,255,0.7), transparent), 
                radial-gradient(1px 1px at 100px 550px, rgba(255,255,255,0.7), transparent), 
                radial-gradient(1px 1px at 500px 250px, rgba(255,255,255,0.7), transparent), 
                radial-gradient(1px 1px at 300px 500px, rgba(255,255,255,0.7), transparent), 
                radial-gradient(1px 1px at 450px 100px, rgba(255,255,255,0.7), transparent), 
                radial-gradient(1px 1px at 50px 350px, rgba(255,255,255,0.7), transparent), 
                radial-gradient(1px 1px at 580px 50px, rgba(255,255,255,0.7), transparent), 
                radial-gradient(1px 1px at 250px 50px, rgba(255,255,255,0.7), transparent);
            background-repeat: repeat;
            background-size: 600px 600px; /* ä¿æŒå¤§å°ºå¯¸å¾ªç¯ï¼Œé¿å…å¯†é›†é‡å¤ */
            animation: moveStars 150s linear infinite; /* ææ…¢é€Ÿç§»åŠ¨ï¼Œæ›´å”¯ç¾ */
            opacity: 0.9;
            pointer-events: none;
        }

        @keyframes moveStars {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-1000px);
            }
        }

        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* --- 2. å·¦ä¾§é¢æ¿ & æ ‡ç­¾æŒ‰é’® --- */
        .left-panel {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 10;
            pointer-events: none;
        }

        .main-title h1 {
            margin: 0;
            font-size: 32px;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #fff, #00dfff);
            -webkit-background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px rgba(0, 223, 255, 0.3);
        }

        .btn-group-left {
            margin-top: 20px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(0, 0, 0, 0.4);
            color: #00dfff;
            border: 1px solid #00dfff;
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            display: none;
        }

            .nav-btn:hover {
                background: #00dfff;
                color: #000;
                box-shadow: 0 0 20px #00dfff;
            }

        /* æ–°å¢ï¼šç®¡ç†æ ‡ç­¾æŒ‰é’® */
        .tag-manage-btn {
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            border: 1px solid #FFD700;
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            display: block;
        }

            .tag-manage-btn:hover {
                background: #FFD700;
                color: #000;
                box-shadow: 0 0 15px #FFD700;
            }

        /* --- 3. å³ä¸Šç»Ÿè®¡ --- */
        .stats-panel {
            position: absolute;
            top: 30px;
            right: 80px;
            z-index: 10;
            display: flex;
            gap: 15px;
            pointer-events: none;
        }

        .stat-card {
            background: rgba(20, 30, 50, 0.7);
            border: 1px solid rgba(100, 200, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .stat-num {
            font-size: 24px;
            color: #FFD700;
            font-weight: bold;
            display: block;
        }

        .stat-desc {
            font-size: 12px;
            color: #aaa;
        }

        /* --- 4. ä¾§è¾¹æ  --- */
        .sidebar-btn {
            position: absolute;
            top: 30px;
            right: 20px;
            z-index: 100;
            width: 40px;
            height: 40px;
            background: rgba(0,223,255,0.1);
            border: 1px solid #00dfff;
            border-radius: 50%;
            color: #00dfff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: 0.3s;
        }

            .sidebar-btn:hover {
                background: #00dfff;
                color: #000;
                box-shadow: 0 0 15px #00dfff;
            }

        .sidebar {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 340px;
            background: rgba(10, 15, 25, 0.95);
            border-left: 1px solid #334;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            z-index: 90;
            display: flex;
            flex-direction: column;
            padding-top: 80px;
            box-shadow: -5px 0 20px rgba(0,0,0,0.8);
        }

            .sidebar.open {
                transform: translateX(0);
            }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
        }

        .year-header {
            color: #FFD700;
            font-weight: bold;
            padding: 12px;
            margin-top: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        /* --- 4. ç™»å½•å¼¹çª—ç‰¹æœ‰ --- */
        #login-mask {
            display: flex;
            z-index: 3000;
        }
        /* åˆå§‹æ˜¾ç¤ºç™»å½•æ¡† */

        /* --- æ–°å¢ï¼šç¼–è¾‘æŒ‰é’®æ ·å¼ --- */
        .btn-edit-rec {
            cursor: pointer;
            color: #00dfff;
            margin-right: 8px;
            font-size: 14px;
            transition: 0.2s;
        }

            .btn-edit-rec:hover {
                color: #fff;
                text-shadow: 0 0 5px #00dfff;
            }
        /* --- 1. ä¿®æ”¹åŸæœ‰çš„ç¼–è¾‘å›¾æ ‡æ ·å¼ï¼šé»˜è®¤éšè— --- */
        .btn-edit-rec {
            display: none; /* æ ¸å¿ƒä¿®æ”¹ï¼šé»˜è®¤ä¸æ˜¾ç¤º */
            cursor: pointer;
            color: #00dfff;
            margin-right: 8px;
            font-size: 14px;
            transition: 0.2s;
        }

        /* --- 2. å½“ä¾§è¾¹æ å¤„äºç¼–è¾‘æ¨¡å¼æ—¶ï¼Œæ˜¾ç¤ºå›¾æ ‡ --- */
        .sidebar.edit-mode .btn-edit-rec {
            display: inline-block; /* æ¿€æ´»æ—¶æ˜¾ç¤º */
            animation: fadeIn 0.3s;
        }

        /* --- 3. æ–°å¢ï¼šå…¨å±€ç¼–è¾‘å¼€å…³æŒ‰é’®æ ·å¼ --- */
        .sidebar-edit-toggle {
            position: absolute;
            top: 80px; /* ä½äºä¾§è¾¹æ å¼€å…³(30px)çš„ä¸‹æ–¹ */
            right: 20px;
            z-index: 100;
            width: 40px;
            height: 40px;
            background: rgba(0,223,255,0.1);
            border: 1px solid #00dfff;
            border-radius: 50%;
            color: #00dfff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: 0.3s;
        }

            /* æ‚¬åœæˆ–æ¿€æ´»çŠ¶æ€ */
            .sidebar-edit-toggle:hover, .sidebar-edit-toggle.active {
                background: #00dfff;
                color: #000;
                box-shadow: 0 0 15px #00dfff;
            }
        /* å¹´ä»½å³ä¾§ç»Ÿè®¡ä¿¡æ¯ */
        .year-stats {
            font-size: 11px;
            color: #aaa;
            font-weight: normal;
        }

        .record-list.hidden {
            display: none;
        }

        .record-item b {
            color: #fff;
            font-size: 14px;
        }

        /* ä¾§è¾¹æ æ ‡ç­¾ä¸å¤©æ•° */
        .rec-tags {
            margin-top: 5px;
        }

        .rec-tag-badge {
            display: inline-block;
            padding: 1px 5px;
            background: rgba(0, 223, 255, 0.15);
            color: #00dfff;
            border: 1px solid rgba(0, 223, 255, 0.3);
            border-radius: 3px;
            font-size: 10px;
            margin-right: 4px;
        }

        .rec-days {
            float: right;
            color: #FFD700;
            font-size: 11px;
            margin-top: 2px;
        }

        /* --- æ–°å¢ï¼šå›½æ——å›¾æ ‡æ ·å¼ --- */
        .flag-icon {
            width: 20px;
            height: 15px;
            object-fit: cover;
            margin-right: 6px;
            border-radius: 2px;
            vertical-align: -2px; /* å¾®è°ƒå‚ç›´å¯¹é½ */
            box-shadow: 0 0 2px rgba(255,255,255,0.3);
        }
        /* --- æ–°å¢ï¼šç‰ˆæœ¬å·åŠæ‚¬æµ®æ¡†æ ·å¼ --- */
        .version-container {
            position: relative;
            display: inline-block;
            margin-top: 5px;
            pointer-events: auto; /* <--- å¿…é¡»æ·»åŠ è¿™ä¸€è¡Œï¼Œå¦åˆ™é¼ æ ‡æ— æ³•æ„Ÿåº” */
        }

        .version-badge {
            padding: 2px 8px;
            background: rgba(0, 223, 255, 0.15);
            border: 1px solid #00dfff;
            border-radius: 4px;
            color: #00dfff;
            font-size: 11px;
            cursor: help; /* é¼ æ ‡æ”¾ä¸Šå»æ˜¾ç¤ºé—®å·/å¸®åŠ©æ‰‹åŠ¿ */
            transition: 0.3s;
        }

            .version-badge:hover {
                background: rgba(0, 223, 255, 0.4);
                box-shadow: 0 0 10px rgba(0, 223, 255, 0.5);
            }

        /* æ‚¬æµ®æ˜¾ç¤ºçš„è¯¦æƒ…æ¡† */
        .version-tooltip {
            display: none; /* é»˜è®¤éšè— */
            position: absolute;
            top: 100%; /* æ˜¾ç¤ºåœ¨ä¸‹æ–¹ */
            left: 0;
            width: 220px;
            background: rgba(16, 30, 50, 0.95);
            border: 1px solid #00dfff;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            margin-top: 8px;
            backdrop-filter: blur(5px);
            color: #ccc;
            font-size: 12px;
            line-height: 1.6;
            text-align: left;
        }

            .version-tooltip h4 {
                margin: 0 0 8px 0;
                color: #FFD700;
                font-size: 13px;
                border-bottom: 1px dashed #445;
                padding-bottom: 5px;
            }

        /* æ ¸å¿ƒäº¤äº’ï¼šé¼ æ ‡æ‚¬åœåœ¨å®¹å™¨ä¸Šæ—¶ï¼Œæ˜¾ç¤ºè¯¦æƒ…æ¡† */
        .version-container:hover .version-tooltip {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* --- 5. å·¦ä¸‹è§’å›¾ä¾‹ --- */
        .legend-box {
            position: absolute;
            bottom: 30px;
            left: 30px;
            z-index: 10;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #445;
            pointer-events: none;
        }

        .legend-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #ddd;
        }

        .color-dot {
            width: 12px;
            height: 12px;
            margin-right: 10px;
            border-radius: 2px;
        }

        /* --- 6. å¼¹çª—æ ·å¼ --- */
        .modal-mask {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: #112233;
            margin: 8% auto;
            padding: 25px;
            width: 400px;
            border: 1px solid #00dfff;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 223, 255, 0.3);
            color: #fff;
        }

        .form-item {
            margin-bottom: 15px;
        }

            .form-item label {
                display: block;
                color: #8ab;
                font-size: 12px;
                margin-bottom: 5px;
            }

            .form-item input, .form-item textarea {
                width: 100%;
                padding: 8px;
                background: rgba(0,0,0,0.3);
                border: 1px solid #345;
                color: #fff;
                border-radius: 4px;
                box-sizing: border-box;
                outline: none;
            }

        .modal-btns {
            text-align: right;
            margin-top: 20px;
        }

        .btn-ok {
            background: #00dfff;
            color: #000;
            border: none;
            padding: 6px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid #666;
            color: #ccc;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        /* --- æ–°å¢ï¼šåˆ é™¤æŒ‰é’®æ ·å¼ --- */
        .btn-del {
            background: transparent;
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: auto; /* è®©åˆ é™¤æŒ‰é’®é å·¦æ˜¾ç¤º */
            float: left; /* å¼ºåˆ¶é å·¦ */
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰ç¼–è¾‘æ—¶æ˜¾ç¤º */
        }

            .btn-del:hover {
                background: #ff4444;
                color: #fff;
            }
        /* --- 7. æ ‡ç­¾é€‰æ‹©å™¨æ ·å¼ --- */
        .tag-selector-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 5px 0;
        }

        .tag-option {
            padding: 4px 10px;
            border: 1px solid #445;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            color: #aaa;
            transition: 0.2s;
        }

            .tag-option.selected {
                background: rgba(0, 223, 255, 0.2);
                border-color: #00dfff;
                color: #fff;
                box-shadow: 0 0 5px rgba(0, 223, 255, 0.3);
            }

        /* --- 8. æ ‡ç­¾ç®¡ç†å¼¹çª—æ ·å¼ --- */
        .tag-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tag-list-manage {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #334;
            padding: 10px;
            border-radius: 4px;
            background: rgba(0,0,0,0.2);
        }

        .manage-tag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px dashed #334;
            font-size: 13px;
        }

        .btn-del-tag {
            color: #ff4444;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 5px;
        }

            .btn-del-tag:hover {
                text-decoration: underline;
            }

        /* --- 1. èƒŒæ™¯å‡çº§ï¼šæå…‰ + ç½‘æ ¼ --- */
        body {
            background-color: #050a14 !important; /* æ·±é‚ƒè“é»‘ */
        }

        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: radial-gradient(circle at 10% 20%, 
            rgba(0, 223, 255, 0.08), 
            transparent 40%), 
                radial-gradient(circle at 90% 80%, 
            rgba(80, 50, 250, 0.08), 
            transparent 40%);
            filter: blur(50px);
            pointer-events: none;
        }

        .grid-texture {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
        }
        /* ç¡®ä¿åŸæœ‰çš„æ˜Ÿæ˜Ÿåœ¨ç½‘æ ¼ä¹‹ä¸Š */
        .stars {
            z-index: 0;
            opacity: 0.5;
        }

        /* --- 2. æ—…è¡Œæ—¥å¿—å¡ç‰‡å‡çº§ --- */
        .record-item {
            position: relative;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 12px;
            overflow: hidden; /* è£å‰ªèƒŒæ™¯å›¾ */
            transition: all 0.3s ease;
            /* é»˜è®¤å·¦è¾¹æ¡† */
            border-left: 3px solid rgba(255,255,255,0.2);
        }

            /* æ‚¬æµ®äº¤äº’ï¼šä¸Šæµ® + å‘å…‰ */
            .record-item:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.3);
            }

        /* åŠ¨æ€èƒŒæ™¯å›¾å®¹å™¨ */
        .rec-bg-img {
            position: absolute;
            top: 0;
            right: 0;
            width: 70%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.6;
            filter: grayscale(50%); /* é»˜è®¤å¾®ç°ï¼Œä¸æŠ¢çœ¼ */
            /* æ ¸å¿ƒæ•ˆæœï¼šä»å·¦(é€æ˜)åˆ°å³(æ˜¾ç¤º)çš„æ¸å˜é®ç½© */
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 99%);
            mask-image: linear-gradient(to right, transparent 0%, black 99%);
            z-index: 0;
            transition: 0.5s;
        }

        .record-item:hover .rec-bg-img {
            opacity: 0.9;
            filter: grayscale(0%);
            transform: scale(1.05); /* æ‚¬æµ®æ—¶å˜äº®ã€å˜è‰² */
        }

        /* --- æ–°å¢ç‰¹æ•ˆæ ·å¼ --- */

        /* 1. æ˜Ÿæ˜Ÿå‘¼å¸é—ªçƒ */
        .blinking-stars {
            animation: moveStars 150s linear infinite, blink 4s ease-in-out infinite alternate;
        }

        @keyframes blink {
            0% {
                opacity: 0.3;
            }

            100% {
                opacity: 0.6;
            }
        }

        /* 2. é¼ æ ‡è·Ÿéšå…‰æ™• */
        #cursor-glow {
            position: fixed;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(0, 223, 255, 0.08) 0%, transparent 60%);
            border-radius: 50%;
            pointer-events: none; /* å¿…é¡»ç©¿é€ï¼Œå¦åˆ™æ— æ³•ç‚¹å‡»åœ°å›¾ */
            z-index: 0;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s;
            mix-blend-mode: screen; /* æ··åˆæ¨¡å¼ï¼Œè®©å…‰æ•ˆæ›´è‡ªç„¶ */
        }

        /* å†…å®¹å±‚çº§è°ƒæ•´ */
        .rec-content {
            position: relative;
            z-index: 1;
            width: 100%;
        }

        /* å†…éƒ¨å¸ƒå±€å¾®è°ƒ */
        .rec-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }

        .rec-place {
            font-size: 15px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .rec-date {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            display: block;
            margin-bottom: 6px;
        }

        /* æ ‡ç­¾æ ·å¼ (ä¿æŒåŸæœ‰é€»è¾‘ï¼Œå¢åŠ é˜´å½±ä»¥é€‚åº”èƒŒæ™¯å›¾) */
        .rec-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .rec-tag-badge {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(2px);
        }

        /* --- æ–°å¢ï¼šåŠ¨æ€æ•°æ®è¾“å…¥æ¡†æ ·å¼ --- */
        .dynamic-data-row {
            display: none; /* é»˜è®¤éšè— */
            gap: 10px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.02);
            padding: 10px;
            border-radius: 6px;
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }

            .dynamic-data-row.active {
                display: flex; /* æ¿€æ´»æ—¶æ˜¾ç¤º flex å¸ƒå±€ */
                animation: fadeIn 0.3s;
            }

        .dynamic-input-group {
            flex: 1;
        }

            .dynamic-input-group label {
                color: #00dfff;
                font-size: 12px;
                margin-bottom: 4px;
                display: block;
            }

            .dynamic-input-group input {
                text-align: center;
                color: #000000 !important;
                font-weight: bold;
            }
        /* --- æ–°å¢ï¼šå¹´åº¦è¿åŠ¨ç»Ÿè®¡é¢æ¿æ ·å¼ --- */
        .year-summary-box {
            display: none; /* é»˜è®¤éšè—ï¼Œéšå¹´ä»½å±•å¼€ */
            background: rgba(0, 0, 0, 0.4);
            margin: 0 10px 10px 10px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 12px;
            animation: slideDown 0.2s ease-out;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }

            .summary-row:last-child {
                border-bottom: none;
            }

        .sum-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sum-data {
            font-family: 'Consolas', monospace;
            color: #fff;
        }

        /* é¢œè‰²å®šä¹‰ */
        .sum-hike {
            color: #50c878;
        }
        /* ç»¿è‰²-å¾’æ­¥ */
        .sum-dive {
            color: #00dfff;
        }
        /* è“é’-æ½œæ°´ */
        .sum-run {
            color: #ffaa00;
        }
        /* æ©™è‰²-è¶Šé‡è·‘ */

    </style>
</head>
<body>

    <div class="stars"></div>
    <div class="ambient-light"></div>
    <div class="grid-texture"></div>
    <div class="stars blinking-stars"></div>

    <!-- æ–°å¢ï¼šé¼ æ ‡è·Ÿéšå…‰æ™• -->
    <div id="cursor-glow"></div>
    <div class="left-panel">
        <div class="main-title">
            <h1>æˆ‘çš„è¶³è¿¹åœ°å›¾</h1>
            <div class="version-container">
                <div class="version-badge">V3.7</div>

                <!-- ç‰ˆæœ¬å·è®¾ç½® -->
                <!-- è¿™é‡Œæ˜¯æ‚¬æµ®æ˜¾ç¤ºçš„è¯¦ç»†ä¿¡æ¯ï¼Œç›´æ¥åœ¨è¿™é‡Œä¿®æ”¹æ–‡å­—å³å¯ -->
                <div class="version-tooltip">
                    <h4>ç‰ˆæœ¬æ›´æ–°æ—¥å¿—</h4>
                    <p>å‘å¸ƒæ—¶é—´: 2025-12-22</p>
                    <ul style="margin:0; padding-left:15px;">
                        <li>V3.7ï¼šæ–°å¢åœ¨çº¿ç™»å½•åŠŸèƒ½</li>
                        <li>V3.6ï¼šæ–°å¢éƒ¨åˆ†è¿åŠ¨è®°å½•åŠŸèƒ½ï¼Œç•Œé¢ä¼˜åŒ–</li>
                        <li>V3.5ï¼šæ–°å¢å¤‡ä»½åŠŸèƒ½</li>
                        <li>V3.4ï¼šæ–°å¢åˆ é™¤è®°å½•åŠŸèƒ½ï¼Œæ–°å¢baseåœ°è®¾ç½®</li>
                        <li>V3.3ï¼šæ–°å¢åä¸‰ä¸ªå›½å®¶åœ°å›¾</li>
                        <li>V3.2ï¼šæ–°å¢è½¯ä»¶ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼Œæ–°å¢è®°å½•ä¿®æ”¹åŠŸèƒ½</li>
                    </ul>
                </div>
            </div>

        </div>

        <!-- ç”¨æˆ·çŠ¶æ€ -->
        <div id="user-status" style="margin-top:15px; margin-bottom:10px; font-size:12px; color:#00dfff; display:none;">
            ğŸ‘¤ <span id="user-email"></span>
            <a href="#" onclick="handleLogout()" style="color:#888; margin-left:5px;">[é€€å‡º]</a>
        </div>
        <div class="btn-group-left">
            <button id="nav-back-btn" class="nav-btn">â† è¿”å›</button>
            <button class="tag-manage-btn" onclick="openTagManager()">ğŸ·ï¸ ç®¡ç†æ ‡ç­¾</button>
            <button class="tag-manage-btn" style="border-color: #FF8C00; color: #FF8C00;" onclick="openBaseManager()">ğŸ  ç®¡ç†Baseåœ°</button>

            <!-- æ–°å¢ï¼šæ•°æ®å¤‡ä»½åŒº (ä¿®å¤äº†ä½ç½®å’Œç‚¹å‡»é—®é¢˜) -->
            <div style="margin-top: 15px; border-top: 1px dashed rgba(0, 223, 255, 0.3); padding-top: 10px; width: 100%; pointer-events: auto;">
                <button class="nav-btn" style="display:inline-block; 
                        font-size:12px; padding:6px 15px; margin-right:5px; border-color:#aaa; color:#ccc;" onclick="exportData()" title="ä¸‹è½½æ•°æ®åˆ°æœ¬åœ°">â¬‡ å¤‡ä»½</button>
                <button class="nav-btn" style="display:inline-block; 
                        font-size:12px; padding:6px 15px; border-color:#aaa; color:#ccc;" onclick="document.getElementById('file-input').click()" title="ä»æœ¬åœ°æ–‡ä»¶æ¢å¤">â¬† æ¢å¤</button>
                <input type="file" id="file-input" style="display: none;" onchange="importData(this)">
            </div>
        </div>
    </div>

    <div class="stats-panel">
        <div class="stat-card">
            <span class="stat-num" id="count-country">0</span>
            <span class="stat-desc">å›½å®¶/åœ°åŒº</span>
        </div>
        <div class="stat-card">
            <span class="stat-num" id="count-total">0</span>
            <span class="stat-desc">è¶³è¿¹æ€»æ•°</span>
        </div>
    </div>

    <div class="legend-box">
        <div class="legend-row"><div class="color-dot" style="background:rgba(255, 215, 0, 0.3)"></div>è¶³è¿¹åˆæ¢ (1å¤„)</div>
        <div class="legend-row"><div class="color-dot" style="background:rgba(255, 215, 0, 0.6)"></div>æ·±åº¦æ¸¸è§ˆ (2å¤„)</div>
        <div class="legend-row"><div class="color-dot" style="background:rgba(255, 215, 0, 1.0); box-shadow:0 0 5px gold;"></div>å®Œå…¨æ¢ç´¢ (3å¤„+)</div>
    </div>

    <div class="sidebar-btn" onclick="toggleSidebar()">â˜°</div>
    <!-- æ–°å¢ï¼šç¼–è¾‘æ¨¡å¼å¼€å…³ (æ”¾åœ¨ä¸‹æ–¹) -->
    <div class="sidebar-edit-toggle" onclick="toggleEditMode()" title="å¼€å¯/å…³é—­ç¼–è¾‘æ¨¡å¼">âœ</div>
    <div class="sidebar" id="sidebar">
        <div style="padding: 20px; font-size:18px; color:#00dfff; font-weight:bold;">æ—…è¡Œæ—¥å¿—</div>
        <div class="sidebar-content" id="log-container"></div>
    </div>

    <div id="map-container"></div>

    <!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
    <div id="login-mask" class="modal-mask">
        <div class="modal" style="text-align:center;">
            <h2 style="color:#00dfff; margin-bottom:20px;">ğŸŒ å¼€å¯äº‘ç«¯æ—…ç¨‹</h2>
            <div class="form-item">
                <input type="email" id="email" placeholder="é‚®ç®±åœ°å€" style="text-align:left;">
            </div>
            <div class="form-item">
                <input type="password" id="password" placeholder="å¯†ç " style="text-align:left;">
            </div>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn-ok" onclick="handleLogin()">ç™»å½•</button>
                <button class="nav-btn" style="display:inline-block;" onclick="handleSignUp()">æ³¨å†Œ</button>
            </div>
            <p id="login-msg" style="color:#ff4444; font-size:12px; margin-top:10px;"></p>
            <div style="margin-top:15px; border-top:1px dashed #334; padding-top:10px;">
                <span style="font-size:12px; color:#888; cursor:pointer;" onclick="useOfflineMode()">æš‚ä¸ç™»å½•ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼ &gt;</span>
            </div>
        </div>
    </div>

    <!-- å½•å…¥è¶³è¿¹å¼¹çª— -->
    <div id="modal-mask" class="modal-mask">
        <div class="modal">
            <h3 style="margin-top:0; color:#00dfff; border-bottom:1px solid #334; padding-bottom:10px;">è®°å½•ç¾å¥½æ—…ç¨‹</h3>

            <div class="form-item">
                <label>ä½ç½®</label>
                <input type="text" id="loc-display" readonly style="color:#FFD700; font-weight:bold; border:none; padding-left:0; background:transparent;">
            </div>

            <div class="form-item" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="input-date">
                </div>
                <div style="width:80px;">
                    <label>å¤©æ•°</label>
                    <input type="number" id="input-days" value="1" min="1" style="text-align:center;">
                </div>
            </div>

            <!-- æ ‡ç­¾é€‰æ‹©åŒº -->
            <div class="form-item">
                <label>é€‰æ‹©æ ‡ç­¾ (å¤šé€‰)</label>
                <div class="tag-selector-container" id="tag-selector-area"></div>
            </div>

            <!-- --- åŠ¨æ€æ•°æ®è¾“å…¥åŒº --- -->
            <!-- 1. å¾’æ­¥/è¶Šé‡è·‘ -->
            <div id="data-hike-run" class="dynamic-data-row">
                <div class="dynamic-input-group">
                    <label>ğŸ“ è·ç¦»(km)</label>
                    <input type="number" id="input-distance" step="0.1">
                </div>
                <div class="dynamic-input-group">
                    <label>â›°ï¸ çˆ¬å‡(m)</label>
                    <input type="number" id="input-climb">
                </div>
            </div>

            <!-- 2. æ½œæ°´ -->
            <div id="data-dive" class="dynamic-data-row">
                <div class="dynamic-input-group">
                    <label>ğŸ¤¿ æ°”ç“¶æ•°</label>
                    <input type="number" id="input-dives">
                </div>
            </div>

            <!-- 3. æ–°å¢ï¼šæ»‘é›ª -->
            <div id="data-ski" class="dynamic-data-row">
                <div class="dynamic-input-group">
                    <label>â›·ï¸ æ»‘é›ªé‡Œç¨‹(km)</label>
                    <input type="number" id="input-ski-dist" step="0.1">
                </div>
            </div>
            <!-- ----------------------- -->

            <div class="form-item">
                <label>å¤‡æ³¨</label>
                <textarea id="input-note" rows="2"></textarea>
            </div>

            <div class="modal-btns">
                <button id="btn-delete" class="btn-del" onclick="deleteRecord()">åˆ é™¤</button>
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-ok" onclick="saveRecord()">ä¿å­˜</button>
            </div>
        </div>
    </div>


    <!-- æ–°å¢ï¼šBaseåœ°ç®¡ç†å¼¹çª— -->
    <div id="base-manager-mask" class="modal-mask">
        <div class="modal">
            <h3 style="margin-top:0; color:#FF8C00; border-bottom:1px solid #334; padding-bottom:10px;">Baseåœ°ç®¡ç† (å¸¸é©»åŸå¸‚)</h3>
            <div class="tag-input-group">
                <input type="text" id="new-base-name" placeholder="è¾“å…¥åŸå¸‚åç§°ï¼Œå¦‚ï¼šä¸Šæµ·å¸‚ã€è‹å·å¸‚">
                <button class="btn-ok" onclick="addNewBase()" style="padding:5px 15px; background:#FF8C00;">æ·»åŠ </button>
            </div>
            <div class="form-item">
                <label>å·²æœ‰Baseåœ° (ç‚¹å‡»åˆ é™¤)</label>
                <div class="tag-list-manage" id="manage-base-list">
                    <!-- JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeBaseManager()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ ‡ç­¾ç®¡ç†å¼¹çª— -->
    <div id="tag-manager-mask" class="modal-mask">
        <div class="modal">
            <h3 style="margin-top:0; color:#FFD700; border-bottom:1px solid #334; padding-bottom:10px;">æ ‡ç­¾ç®¡ç†</h3>
            <div class="tag-input-group">
                <input type="text" id="new-tag-name" placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°ï¼Œå¦‚ï¼šæ»‘é›ª">
                <button class="btn-ok" onclick="addNewTag()" style="padding:5px 15px;">æ·»åŠ </button>
            </div>
            <div class="form-item">
                <label>å·²æœ‰æ ‡ç­¾ (ç‚¹å‡»å³ä¾§åˆ é™¤)</label>
                <div class="tag-list-manage" id="manage-tag-list"></div>
            </div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeTagManager()">å…³é—­</button>
            </div>
        </div>
    </div>


    <script>
        const SUPABASE_URL = 'https://kyslslgfyzunyxpcxody.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_NNtPZSWmyqZiewuAqnjpvA_TEsm9p52';
        // åˆå§‹åŒ– SDK
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;

        // --- 2. åŸºç¡€é…ç½® ---
        const chartDom = document.getElementById('map-container');
        const myChart = echarts.init(chartDom);
        const DATA_KEY = 'travel_map_data_pro';
        const TAGS_KEY = 'travel_map_tags_list';
        const BASE_KEY = 'travel_map_bases_list';

        // åŠ è½½æ•°æ®
        let travelData = JSON.parse(localStorage.getItem(DATA_KEY)) || [];
        // ... åŸæœ‰çš„ travelData å®šä¹‰ ...
        let baseCities = JSON.parse(localStorage.getItem(BASE_KEY)) || [];
        // é»˜è®¤æ ‡ç­¾
        let userTags = JSON.parse(localStorage.getItem(TAGS_KEY)) || ['å¾’æ­¥', 'æ»‘é›ª', 'è‡ªé©¾', 'æ½œæ°´', 'æ‘„å½±', 'ç¾é£Ÿ', 'åšç‰©é¦†', 'è§‚æ˜Ÿ', 'è¶Šé‡è·‘', 'è¶Šé‡è·‘è®­ç»ƒ', 'ä¸­è½¬'];

        // æ–°å¢ï¼šç¦æ­¢ä¸‹é’»çš„åŒºåŸŸåˆ—è¡¨ (ç›´è¾–å¸‚ + æ¸¯æ¾³)
        const NO_DRILL_LIST = ['åŒ—äº¬å¸‚', 'å¤©æ´¥å¸‚', 'ä¸Šæµ·å¸‚', 'é‡åº†å¸‚', 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº', 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº'];


        // å­—å…¸ä¸é…ç½® (ä¿æŒåŸæ ·)
        const CN_MAP = {
            'China': 'ä¸­å›½', 'United States': 'ç¾å›½', 'Russia': 'ä¿„ç½—æ–¯', 'Japan': 'æ—¥æœ¬', 'Australia': 'æ¾³å¤§åˆ©äºš',
            'Canada': 'åŠ æ‹¿å¤§', 'United Kingdom': 'è‹±å›½', 'France': 'æ³•å›½', 'Germany': 'å¾·å›½', 'Italy': 'æ„å¤§åˆ©',
            'Spain': 'è¥¿ç­ç‰™', 'South Korea': 'éŸ©å›½', 'North Korea': 'æœé²œ', 'India': 'å°åº¦', 'Thailand': 'æ³°å›½',
            'Philippines': 'è²å¾‹å®¾', 'Indonesia': 'å°åº¦å°¼è¥¿äºš', 'Malaysia': 'é©¬æ¥è¥¿äºš', 'Vietnam': 'è¶Šå—', 'Nepal': 'å°¼æ³Šå°”',
            'Singapore': 'æ–°åŠ å¡', 'Cambodia': 'æŸ¬åŸ”å¯¨', 'Laos': 'è€æŒ', 'Myanmar': 'ç¼…ç”¸', 'Brazil': 'å·´è¥¿',
            'Argentina': 'é˜¿æ ¹å»·', 'Mexico': 'å¢¨è¥¿å“¥', 'Egypt': 'åŸƒåŠ', 'South Africa': 'å—é', 'Turkey': 'åœŸè€³å…¶',
            'Netherlands': 'è·å…°', 'Switzerland': 'ç‘å£«', 'Sweden': 'ç‘å…¸', 'Norway': 'æŒªå¨', 'Finland': 'èŠ¬å…°',
            'Denmark': 'ä¸¹éº¦', 'New Zealand': 'æ–°è¥¿å…°', 'United Arab Emirates': 'é˜¿è”é…‹', 'Saudi Arabia': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯',
            'Portugal': 'è‘¡è„ç‰™', 'Greece': 'å¸Œè…Š', 'Austria': 'å¥¥åœ°åˆ©', 'Hungary': 'åŒˆç‰™åˆ©', 'Czech Republic': 'æ·å…‹',
            'Ethiopia': 'åŸƒå¡ä¿„æ¯”äºš', 'United Republic of Tanzania': 'å¦æ¡‘å°¼äºš', 'Kenya': 'è‚¯å°¼äºš', 'Rwanda': 'å¢æ—ºè¾¾', 'Oman': 'é˜¿æ›¼', 'Jordan': 'çº¦æ—¦', 'Iran': 'ä¼Šæœ—',
            'Kazakhstan': 'å“ˆè¨å…‹æ–¯å¦', 'Uzbekistan': 'ä¹Œå…¹åˆ«å…‹æ–¯å¦', 'Armenia': 'äºšç¾å°¼äºš', 'Azerbaijan': 'é˜¿å¡æ‹œç–†', 'Georgia': 'æ ¼é²å‰äºš', 'Maldives': 'é©¬å°”ä»£å¤«'
        };
        const MAP_URLS = {
            world: 'https://code.highcharts.com/mapdata/custom/world-highres.geo.json',
            'Thailand': 'https://code.highcharts.com/mapdata/countries/th/th-all.geo.json',
            'Vietnam': 'https://code.highcharts.com/mapdata/countries/vn/vn-all.geo.json',
            'Malaysia': 'https://code.highcharts.com/mapdata/countries/my/my-all.geo.json',
            'Indonesia': 'https://code.highcharts.com/mapdata/countries/id/id-all.geo.json',
            'Philippines': 'https://code.highcharts.com/mapdata/countries/ph/ph-all.geo.json',
            'United States': 'https://code.highcharts.com/mapdata/countries/us/us-all.geo.json',
            'Japan': 'https://code.highcharts.com/mapdata/countries/jp/jp-all.geo.json',
            'United Kingdom': 'https://code.highcharts.com/mapdata/countries/gb/gb-all.geo.json',
            'France': 'https://code.highcharts.com/mapdata/countries/fr/fr-all.geo.json',
            'Germany': 'https://code.highcharts.com/mapdata/countries/de/de-all.geo.json',
            'Italy': 'https://code.highcharts.com/mapdata/countries/it/it-all.geo.json',
            'Spain': 'https://code.highcharts.com/mapdata/countries/es/es-all.geo.json',
            'Russia': 'https://code.highcharts.com/mapdata/countries/ru/ru-all.geo.json',
            'Australia': 'https://code.highcharts.com/mapdata/countries/au/au-all.geo.json',
            'Canada': 'https://code.highcharts.com/mapdata/countries/ca/ca-all.geo.json',
            'Switzerland': 'https://code.highcharts.com/mapdata/countries/ch/ch-all.geo.json',
            'Turkey': 'https://code.highcharts.com/mapdata/countries/tr/tr-all.geo.json',
            'Egypt': 'https://code.highcharts.com/mapdata/countries/eg/eg-all.geo.json',
            'New Zealand': 'https://code.highcharts.com/mapdata/countries/nz/nz-all.geo.json',
            'South Korea': 'https://code.highcharts.com/mapdata/countries/kr/kr-all.geo.json',
            'Hungary': 'https://code.highcharts.com/mapdata/countries/hu/hu-all.geo.json',
            'Czech Republic': 'https://code.highcharts.com/mapdata/countries/cz/cz-all.geo.json',
            'Austria': 'https://code.highcharts.com/mapdata/countries/at/at-all.geo.json',
            'Ethiopia': 'https://code.highcharts.com/mapdata/countries/et/et-all.geo.json',
            'United Republic of Tanzania': 'https://code.highcharts.com/mapdata/countries/tz/tz-all.geo.json',
            'Kenya': 'https://code.highcharts.com/mapdata/countries/ke/ke-all.geo.json',
            'Rwanda': 'https://code.highcharts.com/mapdata/countries/rw/rw-all.geo.json',
            'Oman': 'https://code.highcharts.com/mapdata/countries/om/om-all.geo.json',
            'Jordan': 'https://code.highcharts.com/mapdata/countries/jo/jo-all.geo.json',
            'Iran': 'https://code.highcharts.com/mapdata/countries/ir/ir-all.geo.json',
            'Kazakhstan': 'https://code.highcharts.com/mapdata/countries/kz/kz-all.geo.json',
            'Uzbekistan': 'https://code.highcharts.com/mapdata/countries/uz/uz-all.geo.json',
            'Armenia': 'https://code.highcharts.com/mapdata/countries/am/am-all.geo.json',
            'Azerbaijan': 'https://code.highcharts.com/mapdata/countries/az/az-all.geo.json',
            'Georgia': 'https://code.highcharts.com/mapdata/countries/ge/ge-all.geo.json',
            'Maldives': 'https://code.highcharts.com/mapdata/countries/mv/mv-all.geo.json',
            'Nepal': 'https://code.highcharts.com/mapdata/countries/np/np-all.geo.json'
        };
        const CHINA_PROVINCES = {
            'China': 100000, 'åŒ—äº¬å¸‚': 110000, 'å¤©æ´¥å¸‚': 120000, 'æ²³åŒ—çœ': 130000, 'å±±è¥¿çœ': 140000, 'å†…è’™å¤è‡ªæ²»åŒº': 150000,
            'è¾½å®çœ': 210000, 'å‰æ—çœ': 220000, 'é»‘é¾™æ±Ÿçœ': 230000, 'ä¸Šæµ·å¸‚': 310000, 'æ±Ÿè‹çœ': 320000, 'æµ™æ±Ÿçœ': 330000,
            'å®‰å¾½çœ': 340000, 'ç¦å»ºçœ': 350000, 'æ±Ÿè¥¿çœ': 360000, 'å±±ä¸œçœ': 370000, 'æ²³å—çœ': 410000, 'æ¹–åŒ—çœ': 420000,
            'æ¹–å—çœ': 430000, 'å¹¿ä¸œçœ': 440000, 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 450000, 'æµ·å—çœ': 460000, 'é‡åº†å¸‚': 500000, 'å››å·çœ': 510000,
            'è´µå·çœ': 520000, 'äº‘å—çœ': 530000, 'è¥¿è—è‡ªæ²»åŒº': 540000, 'é™•è¥¿çœ': 610000, 'ç”˜è‚ƒçœ': 620000, 'é’æµ·çœ': 630000,
            'å®å¤å›æ—è‡ªæ²»åŒº': 640000, 'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 650000, 'å°æ¹¾çœ': 710000, 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': 810000, 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': 820000
        };
        const COUNTRY_ISO = {
            'China': 'cn', 'United States': 'us', 'United States of America': 'us',
            'Russia': 'ru', 'Japan': 'jp', 'Australia': 'au', 'Canada': 'ca', 'Nepal': 'np',
            'United Kingdom': 'gb', 'France': 'fr', 'Germany': 'de', 'Italy': 'it',
            'Spain': 'es', 'South Korea': 'kr', 'North Korea': 'kp', 'India': 'in',
            'Thailand': 'th', 'Philippines': 'ph', 'Indonesia': 'id', 'Malaysia': 'my',
            'Vietnam': 'vn', 'Singapore': 'sg', 'Cambodia': 'kh', 'Laos': 'la',
            'Myanmar': 'mm', 'Brazil': 'br', 'Argentina': 'ar', 'Mexico': 'mx',
            'Egypt': 'eg', 'South Africa': 'za', 'Turkey': 'tr', 'Netherlands': 'nl',
            'Switzerland': 'ch', 'Sweden': 'se', 'Norway': 'no', 'Finland': 'fi',
            'Denmark': 'dk', 'New Zealand': 'nz', 'United Arab Emirates': 'ae',
            'Saudi Arabia': 'sa', 'Portugal': 'pt', 'Greece': 'gr', 'Austria': 'at',
            'Hungary': 'hu', 'Czech Republic': 'cz', 'Ethiopia': 'et',
            'United Republic of Tanzania': 'tz', 'Kenya': 'ke',
            'Rwanda': 'rw', 'Oman': 'om', 'Jordan': 'jo', 'Iran': 'ir',
            'Kazakhstan': 'kz', 'Uzbekistan': 'uz', 'Maldives': 'mv',
            'Armenia': 'am', 'Azerbaijan': 'az', 'Georgia': 'ge'
        };
        let currentLevel = 'world';
        let currentScopeName = '';
        let tempClickData = null;
        let editingIndex = null;

        // --- è®¤è¯ä¸åŒæ­¥é€»è¾‘ ---
        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) return alert("è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ");
            const { data, error } = await supabaseClient.auth.signUp({ email, password });
            if (error) document.getElementById('login-msg').innerText = error.message;
            else { alert("æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±æˆ–ç›´æ¥ç™»å½•ã€‚"); handleLogin(); }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) document.getElementById('login-msg').innerText = error.message;
            else { currentUser = data.user; initCloudData(); }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        function useOfflineMode() { document.getElementById('login-mask').style.display = 'none'; }

        async function initCloudData() {
            document.getElementById('login-mask').style.display = 'none';
            document.getElementById('user-status').style.display = 'block';
            document.getElementById('user-email').innerText = currentUser.email.split('@')[0];

            const { data, error } = await supabaseClient.from('user_profiles').select('*').eq('id', currentUser.id).single();
            if (data) {
                travelData = data.travel_data || [];
                userTags = data.tags || userTags;
                baseCities = data.bases || [];
                localStorage.setItem(DATA_KEY, JSON.stringify(travelData)); // åŒæ­¥åˆ°æœ¬åœ°
            } else {
                saveToCloud(); // æ–°ç”¨æˆ·åŒæ­¥æœ¬åœ°åˆ°äº‘ç«¯
            }
            updateLogSidebar(); updateStats(); renderWorld();
        }

        async function saveToCloud() {
            if (!currentUser) return;
            const { error } = await supabaseClient.from('user_profiles').upsert({
                id: currentUser.id, travel_data: travelData, tags: userTags, bases: baseCities
            });
            if (error) console.error("äº‘ç«¯åŒæ­¥å¤±è´¥:", error);
            else console.log("äº‘ç«¯åŒæ­¥æˆåŠŸ");
        }

        // --- æ ·å¼é€»è¾‘ ---
        function getCommonOption(mapName, regions, series = []) {
            const isWorld = mapName === 'world';
            return {
                backgroundColor: 'rgba(0,0,0,0)',
                tooltip: {
                    trigger: 'item', backgroundColor: 'rgba(0,10,20,0.9)', borderColor: '#00dfff', textStyle: { color: '#fff' },
                    formatter: params => {
                        if (params.componentType === 'series') {
                            const d = params.data.custom;
                            let tagsStr = d.tags && d.tags.length ? `<br>æ ‡ç­¾: <span style="color:#00dfff">${d.tags.join(', ')}</span>` : '';
                            let daysStr = d.days ? `<br>æ—¶é•¿: ${d.days}å¤©` : '';
                            return `<b>${params.data.name}</b><br>${d.date}${daysStr}${tagsStr}<br>${d.note}`;
                        }
                        return CN_MAP[params.name] || params.name;
                    }
                },
                geo: {
                    map: mapName, roam: true, aspectScale: 0.75, layoutCenter: ['50%', '50%'], layoutSize: '100%',
                    label: {
                        show: true, color: '#fff', fontSize: 10, textShadowColor: '#000', textShadowBlur: 2,
                        formatter: p => isWorld ? (CN_MAP[p.name] ? CN_MAP[p.name] : "") : p.name
                    },
                    itemStyle: {
                        areaColor: '#1a2b3c', borderColor: '#4facfe', borderWidth: 0.6,
                        shadowColor: 'rgba(0, 223, 255, 0.4)', shadowBlur: 10
                    },
                    emphasis: { itemStyle: { areaColor: '#00dfff', shadowBlur: 20 }, label: { show: true, color: '#000' } },
                    select: { disabled: true },
                    regions: regions
                },
                series: series
            };
        }

        // --- æ ‡ç­¾ç®¡ç†é€»è¾‘ ---
        function openTagManager() {
            const listDiv = document.getElementById('manage-tag-list');
            listDiv.innerHTML = '';
            userTags.forEach((tag, index) => {
                let item = document.createElement('div');
                item.className = 'manage-tag-item';
                item.innerHTML = `<span>${tag}</span> <span class="btn-del-tag" onclick="deleteTag(${index})">åˆ é™¤</span>`;
                listDiv.appendChild(item);
            });
            document.getElementById('tag-manager-mask').style.display = 'block';
        }

        function closeTagManager() { document.getElementById('tag-manager-mask').style.display = 'none'; }

        function addNewTag() {
            const input = document.getElementById('new-tag-name');
            const val = input.value.trim();
            if (val && !userTags.includes(val)) {
                userTags.push(val);
                localStorage.setItem(TAGS_KEY, JSON.stringify(userTags));
                saveToCloud();
                input.value = '';
                openTagManager();
            } else if (userTags.includes(val)) {
                alert('æ ‡ç­¾å·²å­˜åœ¨');
            }
        }

        // --- æ–°å¢ï¼šBase ç®¡ç†é€»è¾‘ ---
        function openBaseManager() {
            const listDiv = document.getElementById('manage-base-list');
            listDiv.innerHTML = '';
            baseCities.forEach((city, index) => {
                let item = document.createElement('div');
                item.className = 'manage-tag-item';
                // æ©™è‰²æ˜¾ç¤º
                item.innerHTML = `<span style="color:#FF8C00">${city}</span> <span class="btn-del-tag" onclick="deleteBase(${index})">åˆ é™¤</span>`;
                listDiv.appendChild(item);
            });
            document.getElementById('base-manager-mask').style.display = 'block';
        }

        function closeBaseManager() {
            document.getElementById('base-manager-mask').style.display = 'none';
            // å…³é—­æ—¶åˆ·æ–°åœ°å›¾ï¼Œä»¥æ˜¾ç¤º/ç§»é™¤æ©™è‰²
            if (currentLevel === 'china') renderChina();
            else if (currentLevel === 'province') renderProvince(currentScopeName, CHINA_PROVINCES[currentScopeName]);
        }

        function addNewBase() {
            const input = document.getElementById('new-base-name');
            const val = input.value.trim();
            if (val && !baseCities.includes(val)) {
                baseCities.push(val);
                localStorage.setItem(BASE_KEY, JSON.stringify(baseCities));
                saveToCloud();
                input.value = '';
                openBaseManager();
            } else if (baseCities.includes(val)) {
                alert('è¯¥åŸå¸‚å·²è®¾ä¸ºBase');
            }
        }

        function deleteBase(index) {
            if (confirm('ç¡®å®šç§»é™¤è¯¥Baseåœ°å—ï¼Ÿ')) {
                baseCities.splice(index, 1);
                localStorage.setItem(BASE_KEY, JSON.stringify(baseCities));
                saveToCloud();
                openBaseManager();
            }
        }
        function deleteTag(index) {
            if (confirm('ç¡®å®šåˆ é™¤æ­¤æ ‡ç­¾å—ï¼Ÿ')) {
                userTags.splice(index, 1);
                localStorage.setItem(TAGS_KEY, JSON.stringify(userTags));
                saveToCloud();
                openTagManager();
            }
        }

        // --- å½•å…¥çª—å£é€»è¾‘ (å«æ ‡ç­¾é€‰æ‹©ä¸å¤©æ•°) ---
        function setupClickEvent(country, fixedProvince) {
            myChart.off('click');
            myChart.on('click', params => {
                if (params.componentType === 'geo') {
                    // 1. è·å–ç‚¹å‡»åæ ‡
                    let coord = myChart.convertFromPixel('geo', [params.event.offsetX, params.event.offsetY]);

                    // 2. åˆå§‹åŒ–ä¸´æ—¶æ•°æ®
                    tempClickData = {
                        country: country,
                        province: fixedProvince || params.name,
                        city: fixedProvince ? params.name : '',
                        lng: coord[0],
                        lat: coord[1]
                    };

                    // 3. è®¾ç½®ä½ç½®å›æ˜¾
                    let cnC = CN_MAP[country] || country;
                    let loc = cnC + (tempClickData.city ? ` Â· ${tempClickData.province} Â· ${tempClickData.city}` : ` Â· ${tempClickData.province}`);
                    document.getElementById('loc-display').value = loc;

                    // 4. é‡ç½®å¸¸è§„è¾“å…¥æ¡†
                    document.getElementById('input-date').valueAsDate = new Date();
                    document.getElementById('input-days').value = 1;
                    document.getElementById('input-note').value = '';

                    // 5. é‡ç½®å¹¶éšè—åŠ¨æ€æ•°æ®è¾“å…¥æ¡† (æ³¨æ„ï¼šå¿…é¡»å¯¹åº” HTML ä¸­çš„ ID)
                    document.getElementById('input-distance').value = '';
                    document.getElementById('input-climb').value = '';
                    document.getElementById('input-dives').value = '';
                    document.getElementById('input-ski-dist').value = ''; // æ–°å¢ï¼šæ»‘é›ª

                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€ç±»
                    document.getElementById('data-hike-run').classList.remove('active');
                    document.getElementById('data-dive').classList.remove('active');
                    document.getElementById('data-ski').classList.remove('active'); // æ–°å¢ï¼šæ»‘é›ª

                    // 6. é‡ç½®ç¼–è¾‘çŠ¶æ€ (éšè—åˆ é™¤æŒ‰é’®)
                    editingIndex = null;
                    const delBtn = document.getElementById('btn-delete');
                    if (delBtn) delBtn.style.display = 'none';

                    // 7. ç”Ÿæˆæ ‡ç­¾é€‰æ‹©å™¨
                    const tagArea = document.getElementById('tag-selector-area');
                    if (tagArea) {
                        tagArea.innerHTML = '';
                        userTags.forEach(tag => {
                            let span = document.createElement('span');
                            span.className = 'tag-option';
                            span.innerText = tag;

                            // ç»‘å®šç‚¹å‡»äº‹ä»¶
                            span.onclick = function () {
                                this.classList.toggle('selected');
                                checkDynamicInputs(); // ç‚¹å‡»æ—¶ç«‹å³æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºè¾“å…¥æ¡†
                            };

                            tagArea.appendChild(span);
                        });
                    }

                    // 8. æ˜¾ç¤ºå¼¹çª—
                    document.getElementById('modal-mask').style.display = 'block';
                }
            });
        }

        function closeModal() { document.getElementById('modal-mask').style.display = 'none'; }

        function saveRecord() {
            // 1. è·å–åŸºç¡€æ•°æ®
            const date = document.getElementById('input-date').value;
            const note = document.getElementById('input-note').value;
            const days = parseInt(document.getElementById('input-days').value) || 1;

            // 2. è·å–åŠ¨æ€æ•°æ®
            const dist = document.getElementById('input-distance').value;
            const climb = document.getElementById('input-climb').value;
            const dives = document.getElementById('input-dives').value;
            const skiDist = document.getElementById('input-ski-dist').value; // æ–°å¢

            // 3. è·å–æ ‡ç­¾
            let selectedTags = [];
            document.querySelectorAll('.tag-option.selected').forEach(el => selectedTags.push(el.innerText));

            // 4. æ„å»ºå¯¹è±¡
            const recordObj = {
                ...tempClickData,
                date, days, note,
                tags: selectedTags,
                // æ•°æ®å­—æ®µ
                distance: dist,
                climb: climb,
                dives: dives,
                skiDist: skiDist // ä¿å­˜æ»‘é›ªé‡Œç¨‹
            };

            if (editingIndex !== null) {
                travelData[editingIndex] = recordObj;
                editingIndex = null;
            } else {
                travelData.push(recordObj);
            }

            // 5. ä¿å­˜å¹¶åˆ·æ–°
            localStorage.setItem(DATA_KEY, JSON.stringify(travelData));
            saveToCloud();

            closeModal();
            updateLogSidebar();
            updateStats();

            // åˆ·æ–°åœ°å›¾
            if (currentLevel === 'province') renderProvince(currentScopeName, CHINA_PROVINCES[currentScopeName]);
            else if (currentLevel === 'foreign') renderForeign(currentScopeName);
            else if (currentLevel === 'world') renderWorld();
            else renderChina();
        }

        // --- æ–°å¢ï¼šæ£€æŸ¥æ ‡ç­¾å¹¶æ˜¾ç¤ºå¯¹åº”è¾“å…¥æ¡†çš„è¾…åŠ©å‡½æ•° ---
        function checkDynamicInputs() {
            // 1. è·å–æ‰€æœ‰å·²é€‰æ ‡ç­¾
            let selectedTags = [];
            document.querySelectorAll('.tag-option.selected').forEach(el => selectedTags.push(el.innerText));
            const tStr = selectedTags.join(',');

            // 2. é€»è¾‘åˆ¤æ–­
            const showHikeRun = tStr.includes('å¾’æ­¥') || tStr.includes('è¶Šé‡è·‘');
            const showDive = tStr.includes('æ½œæ°´');
            const showSki = tStr.includes('æ»‘é›ª');

            // 3. åˆ‡æ¢ DOM æ˜¾ç¤ºçŠ¶æ€
            const divHike = document.getElementById('data-hike-run');
            const divDive = document.getElementById('data-dive');
            const divSki = document.getElementById('data-ski');

            if (divHike) {
                if (showHikeRun) divHike.classList.add('active');
                else divHike.classList.remove('active');
            }
            if (divDive) {
                if (showDive) divDive.classList.add('active');
                else divDive.classList.remove('active');
            }
            if (divSki) {
                if (showSki) divSki.classList.add('active');
                else divSki.classList.remove('active');
            }
        }

        // --- æ–°å¢ï¼šåˆ é™¤è®°å½•é€»è¾‘ ---
        function deleteRecord() {
            if (editingIndex === null) return; // é˜²å¾¡æ€§ä»£ç 
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è¶³è¿¹å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) return;

            // ä»æ•°ç»„ä¸­ç§»é™¤
            travelData.splice(editingIndex, 1);
            // æ›´æ–°æœ¬åœ°å­˜å‚¨
            localStorage.setItem(DATA_KEY, JSON.stringify(travelData));
            saveToCloud();
            closeModal();
            updateLogSidebar();
            updateStats();

            // åˆ·æ–°å½“å‰åœ°å›¾è§†å›¾
            if (currentLevel === 'province') renderProvince(currentScopeName, CHINA_PROVINCES[currentScopeName]);
            else if (currentLevel === 'foreign') renderForeign(currentScopeName);
            else if (currentLevel === 'world') renderWorld();
            else renderChina();
        }
        // --- æ–°å¢ï¼šè§¦å‘ç¼–è¾‘é€»è¾‘ ---
        function editRecord(index) {
            const r = travelData[index];
            editingIndex = index; // æ ‡è®°å½“å‰æ­£åœ¨ç¼–è¾‘

            // 1. æ¢å¤ä¸´æ—¶æ•°æ® (é˜²æ­¢ä¿å­˜æ—¶ç»çº¬åº¦ä¸¢å¤±)
            tempClickData = {
                country: r.country,
                province: r.province,
                city: r.city,
                lng: r.lng,
                lat: r.lat
            };

            // 2. å›æ˜¾å¸¸è§„æ•°æ®
            let cnC = CN_MAP[r.country] || r.country;
            let loc = cnC + (r.city ? ` Â· ${r.province} Â· ${r.city}` : ` Â· ${r.province}`);
            document.getElementById('loc-display').value = loc + " (ç¼–è¾‘)";
            document.getElementById('input-date').value = r.date;
            document.getElementById('input-days').value = r.days || 1;
            document.getElementById('input-note').value = r.note || '';

            // 3. å›æ˜¾åŠ¨æ€æ•°æ® (æ–°å¢)
            document.getElementById('input-distance').value = r.distance || '';
            document.getElementById('input-climb').value = r.climb || '';
            document.getElementById('input-dives').value = r.dives || '';
            document.getElementById('input-ski-dist').value = r.skiDist || '';

            // 4. æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            document.getElementById('btn-delete').style.display = 'inline-block'; // è¿™é‡Œè¦ç”¨ block æˆ– inline-blockï¼Œå–å†³äºä½ çš„ CSS

            // 5. å›æ˜¾æ ‡ç­¾é€‰ä¸­çŠ¶æ€
            const tagArea = document.getElementById('tag-selector-area');
            tagArea.innerHTML = '';
            userTags.forEach(tag => {
                let span = document.createElement('span');
                span.className = 'tag-option';
                span.innerText = tag;

                // å¦‚æœè®°å½•ä¸­æœ‰è¿™ä¸ªæ ‡ç­¾ï¼Œè®¾ä¸ºé€‰ä¸­
                if (r.tags && r.tags.includes(tag)) {
                    span.classList.add('selected');
                }

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                span.onclick = function () {
                    this.classList.toggle('selected');
                    checkDynamicInputs();
                };
                tagArea.appendChild(span);
            });

            // 6. åˆå§‹åŒ–åŠ¨æ€è¾“å…¥æ¡†æ˜¾ç¤ºçŠ¶æ€ (æ ¹æ®å›æ˜¾çš„æ ‡ç­¾)
            checkDynamicInputs();

            // 7. æ‰“å¼€å¼¹çª—
            document.getElementById('modal-mask').style.display = 'block';
        }

        // --- ä¾§è¾¹æ  (å¹´ä»½ç»Ÿè®¡ä¸æ ‡ç­¾æ˜¾ç¤º) ---
        function updateLogSidebar() {
            const container = document.getElementById('log-container');
            container.innerHTML = '';

            // ç´¢å¼•æ˜ å°„
            let indexedData = travelData.map((item, index) => ({ ...item, originalIndex: index }));
            let groups = {};
            indexedData.forEach(r => {
                let y = r.date.substring(0, 4) || 'æœªçŸ¥';
                if (!groups[y]) groups[y] = [];
                groups[y].push(r);
            });

            Object.keys(groups).sort((a, b) => b - a).forEach(year => {
                let recs = groups[year].sort((a, b) => new Date(b.date) - new Date(a.date));
                let totalDays = recs.reduce((sum, r) => sum + (parseInt(r.days) || 1), 0);

                // --- A. è®¡ç®—å¹´åº¦è¿åŠ¨ç»Ÿè®¡ ---
                let stats = {
                    hike: { count: 0, dist: 0, climb: 0 },
                    dive: { count: 0 }, // æ½œæ°´é€šå¸¸ç»Ÿè®¡æ°”ç“¶æ•°(dives)æˆ–æ¬¡æ•°
                    run: { count: 0, dist: 0, climb: 0 }
                };

                recs.forEach(r => {
                    const tStr = (r.tags || []).join(',');

                    // å¾’æ­¥ç»Ÿè®¡
                    if (tStr.includes('å¾’æ­¥')) {
                        stats.hike.count++;
                        stats.hike.dist += parseFloat(r.distance) || 0;
                        stats.hike.climb += parseFloat(r.climb) || 0;
                    }

                    // æ½œæ°´ç»Ÿè®¡ (ç´¯è®¡æ°”ç“¶æ•°)
                    if (tStr.includes('æ½œæ°´')) {
                        // è¿™é‡Œå‡è®¾æ¯æ¬¡è®°å½•æ˜¯ä¸€æ¬¡æ½œæ°´æ—…è¡Œï¼Œç´¯åŠ è¾“å…¥çš„ input-dives
                        // å¦‚æœåªæ˜¯ä¸€æ¬¡è®°å½•ç®—ä¸€æ¬¡ï¼Œå°±ç”¨ count++ï¼Œè¿™é‡Œé‡‡ç”¨ç´¯åŠ æ°”ç“¶æ•°é€»è¾‘
                        stats.dive.count += parseFloat(r.dives) || 0;
                    }

                    // è¶Šé‡è·‘ç»Ÿè®¡ (å«è®­ç»ƒ)
                    if (tStr.includes('è¶Šé‡è·‘')) {
                        stats.run.count++;
                        stats.run.dist += parseFloat(r.distance) || 0;
                        stats.run.climb += parseFloat(r.climb) || 0;
                    }
                });

                // æ„å»ºç»Ÿè®¡ HTML (ä»…å½“æœ‰æ•°æ®æ—¶æ˜¾ç¤ºå¯¹åº”è¡Œ)
                let statsContent = '';

                if (stats.hike.count > 0) {
                    statsContent += `
                                <div class="summary-row sum-hike">
                                    <span class="sum-title">ğŸš¶ å¾’æ­¥ (${stats.hike.count}æ¬¡)</span>
                                    <span class="sum-data">${stats.hike.dist.toFixed(1)}km / ${stats.hike.climb}m</span>
                                </div>`;
                }
                if (stats.run.count > 0) {
                    statsContent += `
                                <div class="summary-row sum-run">
                                    <span class="sum-title">ğŸƒ è¶Šé‡è·‘ (${stats.run.count}æ¬¡)</span>
                                    <span class="sum-data">${stats.run.dist.toFixed(1)}km / ${stats.run.climb}m</span>
                                </div>`;
                }
                if (stats.dive.count > 0) {
                    statsContent += `
                                <div class="summary-row sum-dive">
                                    <span class="sum-title">ğŸ¤¿ æ½œæ°´</span>
                                    <span class="sum-data">ç´¯è®¡ ${stats.dive.count} ç“¶</span>
                                </div>`;
                }

                // åªæœ‰å½“æœ‰è¿åŠ¨æ•°æ®æ—¶ï¼Œæ‰åŒ…è£¹å¤–æ¡†
                let summaryBoxHtml = '';
                if (statsContent) {
                    summaryBoxHtml = `<div class="year-summary-box">${statsContent}</div>`;
                }

                // å¹´ä»½æ ‡é¢˜
                let header = document.createElement('div');
                header.className = 'year-header';
                header.innerHTML = `<span>${year}</span> <span class="year-stats">${recs.length} æ¬¡ / ${totalDays} å¤©</span>`;

                // 2. ç»Ÿè®¡é¢æ¿å®¹å™¨ (æ–°å»º)
                let summaryDiv = document.createElement('div');
                summaryDiv.innerHTML = summaryBoxHtml;
                // æ³¨æ„ï¼šsummaryDiv æœ¬èº«æ˜¯ä¸ª wrapperï¼Œæˆ‘ä»¬éœ€è¦æ§åˆ¶å†…éƒ¨ .year-summary-box çš„æ˜¾ç¤º

                // åˆ—è¡¨å®¹å™¨
                let list = document.createElement('div');
                list.className = 'record-list';
                list.style.display = 'none'; // é»˜è®¤æŠ˜å 

                recs.forEach(r => {
                    let div = document.createElement('div');
                    div.className = 'record-item';

                    // --- 1. èƒŒæ™¯å›¾ä¸è¾¹æ¡†é¢œè‰²åŒ¹é…é€»è¾‘ ---
                    let bgUrl = '';
                    let borderColor = ''; // é»˜è®¤è¾¹æ¡†

                    if (r.tags && r.tags.length > 0) {
                        const t = r.tags.join(',');

                        if (t.includes('è¶Šé‡è·‘')) { // åŒ…å«"è¶Šé‡è·‘"æˆ–"è¶Šé‡è·‘è®­ç»ƒ"
                            bgUrl = 'https://images.unsplash.com/photo-1504025468847-0e438279542c?q=80&w=400';
                            borderColor = '#ffaa00';  // æ©™è‰²
                        } else if (t.includes('æ»‘é›ª')) {
                            bgUrl = 'https://images.unsplash.com/photo-1511880200544-0170efd77eff?q=80&w=400';
                            borderColor = '#00dfff'; // å†°è“
                        } else if (t.includes('æ½œæ°´')) {
                            bgUrl = 'https://images.unsplash.com/photo-1544551763-46a013bb70d5?q=80&w=400';
                            borderColor = '#0055ff'; // æ·±è“
                        } else if (t.includes('è§‚æ˜Ÿ')) {
                            bgUrl = 'https://images.unsplash.com/photo-1506703719100-a0f3a48c0f86?q=80&w=400';
                            borderColor = '#9933ff'; // ç´«è‰²
                        } else if (t.includes('å¾’æ­¥')) {
                            bgUrl = 'https://images.unsplash.com/photo-1551632811-561732d1e306?q=80&w=400';
                            borderColor = '#50c878'; // ç»¿è‰²
                        } else if (t.includes('æ‘„å½±')) {
                            bgUrl = 'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?q=80&w=400';
                            borderColor = '#ccc'; // é“¶ç°
                        } else if (t.includes('è‡ªé©¾')) {
                            bgUrl = 'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=400';
                            borderColor = '#FFD700'; // é‡‘é»„
                        } else if (t.includes('ç¾é£Ÿ')) {
                            bgUrl = 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=400';
                            borderColor = '#ff4444'; // çº¢è‰²
                        } else if (t.includes('ä¸­è½¬')) {
                            bgUrl = 'https://images.unsplash.com/photo-1545488286-6fe608f23485?q=80&w=400';
                            borderColor = '#708090'; // çŸ³æ¿ç°
                        } else if (t.includes('çº¯ç©')) {
                            bgUrl = 'https://images.unsplash.com/photo-1618933198854-ee406476827c?q=80&w=400';
                            borderColor = '#FFE4E1'; // è–„é›¾ç«ç‘°
                        } else if (t.includes('éª‘è¡Œ')) {
                            bgUrl = 'https://images.unsplash.com/photo-1696832610884-69ba2bb887cb?q=80&w=400';
                            borderColor = '#BDB76B'; //
                        } else if (t.includes('åšç‰©é¦†')) {
                            bgUrl = 'https://images.unsplash.com/photo-1614819752722-a1abb5b9a3cc?q=80&w=400';
                            borderColor = '#eebb44'; // å¤å…¸é‡‘/ç¥ç€è‰²
                        }
                    }

                    // åº”ç”¨è¾¹æ¡†è‰²
                    if (borderColor) div.style.borderLeftColor = borderColor;

                    // --- 2. æ„å»ºå†…å®¹ ---
                    let cn = CN_MAP[r.country] || r.country;
                    let place = cn + (r.city ? ` Â· ${r.city}` : ` Â· ${r.province}`);

                    let tagsHtml = '';
                    if (r.tags) r.tags.forEach(tag => tagsHtml += `<span class="rec-tag-badge">${tag}</span>`);

                    // å›½æ——
                    let iso = (typeof COUNTRY_ISO !== 'undefined' && COUNTRY_ISO[r.country]) ? COUNTRY_ISO[r.country].toLowerCase() : null;
                    let flagImg = iso ? `<img src="https://flagcdn.com/w40/${iso}.png" class="flag-icon">` : '';

                    // èƒŒæ™¯å›¾ HTML
                    let bgDiv = bgUrl ? `<div class="rec-bg-img" style="background-image: url('${bgUrl}');"></div>` : '';

                    // --- æ–°å¢ï¼šæ„å»ºæ•°æ®å±•ç¤º HTML ---
                    let statsHtml = '';
                    if (r.distance || r.climb || r.dives || r.skiDist) {
                        let parts = [];
                        if (r.distance) parts.push(`ğŸ“ ${r.distance}km`);
                        if (r.climb) parts.push(`â›°ï¸ ${r.climb}m`);
                        if (r.dives) parts.push(`ğŸ¤¿ ${r.dives}ç“¶`);
                        if (r.skiDist) parts.push(`â›·ï¸ ${r.skiDist}km`);
                        // ç”¨é‡‘è‰²å­—ä½“æ˜¾ç¤º
                        statsHtml = `<div style="margin-top:4px; font-size:11px; color:#FFD700;">${parts.join(' &nbsp;|&nbsp; ')}</div>`;
                    }

                    // --- æ–°å¢ï¼šå¤‡æ³¨æ˜¾ç¤ºé€»è¾‘ ---
                    let noteHtml = '';
                    if (r.note && r.note.trim() !== '') {
                        noteHtml = `
                                    <div style="margin-top:6px; padding-top:4px; border-top:1px dashed rgba(255,255,255,0.15); font-size:12px; color:#aab; font-style:italic; line-height:1.4;">
                                        ${r.note}
                                    </div>
                                `;
                    }

                    div.innerHTML = `
                                ${bgDiv}
                                <div class="rec-content">
                                    <div class="rec-top">
                                        <div style="display:flex; align-items:center;">
                                            ${flagImg} <span>${place}</span>
                                        </div><span class="rec-days">${r.days || 1}å¤©</span>
                                        <span class="btn-edit-rec" onclick="editRecord(${r.originalIndex})">âœ</span>
                                    </div>
                                     <div style="display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:5px;">
                                        <span class="rec-date" style="margin-bottom:0;">${r.date}</span>
                                        <div class="rec-tags">${tagsHtml}</div>
                                    </div>

                                    ${statsHtml}
                                    ${noteHtml}

                                    </div>

                            `;
                    list.appendChild(div);
                });

                // --- C. ç‚¹å‡»æŠ˜å äº‹ä»¶ (åŒæ—¶æ§åˆ¶åˆ—è¡¨å’Œç»Ÿè®¡æ¡†) ---
                header.onclick = function () {
                    const sumBox = summaryDiv.querySelector('.year-summary-box');
                    if (list.style.display === 'none') {
                        list.style.display = 'block';
                        if (sumBox) sumBox.style.display = 'block';
                    } else {
                        list.style.display = 'none';
                        if (sumBox) sumBox.style.display = 'none';
                    }
                };

                container.appendChild(header);
                container.appendChild(summaryDiv);
                container.appendChild(list);
            });
        }

        // --- åœ°å›¾æ¸²æŸ“å‡½æ•° ---

        function renderWorld() {
            currentLevel = 'world';
            updateBackButton(false);
            myChart.showLoading({ text: 'åŠ è½½é«˜ç²¾åœ°å›¾...', color: '#00dfff', maskColor: 'rgba(0,0,0,0.5)' });
            $.getJSON(MAP_URLS.world, function (geo) {
                myChart.hideLoading();
                echarts.registerMap('world', geo);
                let regions = [];
                geo.features.forEach(f => {
                    let name = f.properties.name;
                    let count = new Set(travelData.filter(r => r.country === name).map(r => r.province)).size;
                    let color = getHeatColor(count);
                    if (color) regions.push({ name: name, itemStyle: { areaColor: color } });
                });
                myChart.setOption(getCommonOption('world', regions), true);
                myChart.off('click');
                myChart.on('click', params => {
                    if (params.componentType === 'geo') {
                        if (params.name === 'China') renderChina();
                        else if (MAP_URLS[params.name]) renderForeign(params.name);
                        else alert(`æš‚æ—  [${CN_MAP[params.name] || params.name}] åœ°å›¾æ•°æ®`);
                    }
                });
            });
        }

        function renderChina() {
            currentLevel = 'china';
            currentScopeName = 'China';
            updateBackButton(true, "â† è¿”å›ä¸–ç•Œ", renderWorld);

            myChart.showLoading();
            $.getJSON(`https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json`, function (geo) {
                myChart.hideLoading();
                echarts.registerMap('china', geo);

                let regions = [];
                geo.features.forEach(f => {
                    let pName = f.properties.name;

                    // 1. è®¡ç®—çƒ­åŠ›å›¾é¢œè‰²
                    let count = new Set(travelData.filter(r => r.country === 'China' && r.province === pName).map(r => r.city)).size;
                    let color = getHeatColor(count); // è·å–åŸæ¥çš„é»„è‰²/æ·±é»„è‰²

                    // 2. Baseåœ°ä¼˜å…ˆç€è‰²é€»è¾‘ (æ©™è‰²)
                    // å¦‚æœè¿™ä¸ªçœ/ç›´è¾–å¸‚çš„åå­—åœ¨ Baseåˆ—è¡¨ä¸­ (ä¾‹å¦‚ 'ä¸Šæµ·å¸‚')ï¼Œå¼ºåˆ¶è¦†ç›–ä¸ºæ©™è‰²
                    if (baseCities.includes(pName)) {
                        color = '#FF8C00'; // æ©™è‰²
                    }

                    if (color) regions.push({ name: pName, itemStyle: { areaColor: color } });
                });

                myChart.setOption(getCommonOption('china', regions), true);

                myChart.off('click');
                myChart.on('click', params => {
                    if (params.componentType === 'geo') {
                        // --- ä¿®æ”¹ï¼šå¢åŠ ç¦æ­¢ä¸‹é’»åˆ¤æ–­ ---
                        if (NO_DRILL_LIST.includes(params.name)) {
                            // å¦‚æœæ˜¯ç›´è¾–å¸‚æˆ–æ¸¯æ¾³ï¼Œä¸è¿›å…¥ä¸‹ä¸€çº§ï¼Œç›´æ¥å½“ä½œç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆå½•å…¥è¶³è¿¹ï¼‰
                            // æ¨¡æ‹Ÿç‚¹å‡»åæ ‡è½¬æ¢
                            let coord = myChart.convertFromPixel('geo', [params.event.offsetX, params.event.offsetY]);
                            // æ‰‹åŠ¨è§¦å‘å½•å…¥å¼¹çª—ï¼Œçœä»½å’ŒåŸå¸‚éƒ½å¡«åŒä¸€ä¸ªåå­—
                            openDirectCityModal('China', params.name, coord);
                        } else {
                            // æ­£å¸¸ä¸‹é’»é€»è¾‘
                            let code = CHINA_PROVINCES[params.name];
                            if (code) renderProvince(params.name, code);
                        }
                    }
                });
            });
        }

        // --- æ–°å¢ï¼šæ•°æ®å¯¼å‡º (ä¸‹è½½ JSON) ---
        function exportData() {
            if (travelData.length === 0 && userTags.length === 0 && baseCities.length === 0) {
                alert("æš‚æ— æ•°æ®å¯å¤‡ä»½");
                return;
            }

            // æ‰“åŒ…æ‰€æœ‰æ•°æ®
            const backupObj = {
                version: "3.1",
                timestamp: new Date().toLocaleString(),
                data: travelData,
                tags: userTags,
                bases: baseCities
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupObj));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            // æ–‡ä»¶åå¸¦ä¸Šæ—¥æœŸ
            const dateStr = new Date().toISOString().slice(0, 10);
            downloadAnchorNode.setAttribute("download", `travel_map_backup_${dateStr}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // --- æ–°å¢ï¼šæ•°æ®å¯¼å…¥ (è¯»å– JSON) ---
        function importData(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);

                    // ç®€å•çš„æ ¼å¼æ ¡éªŒ
                    if (!json.data || !json.tags) {
                        throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®");
                    }

                    if (!confirm(`æ£€æµ‹åˆ°å¤‡ä»½æ–‡ä»¶ï¼š\næ—¶é—´ï¼š${json.timestamp}\nè®°å½•æ•°ï¼š${json.data.length}\n\nç¡®å®šè¦è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                        inputElement.value = ''; // æ¸…ç©ºé€‰æ‹©
                        return;
                    }

                    // è¦†ç›–æœ¬åœ°æ•°æ®
                    travelData = json.data;
                    userTags = json.tags;
                    // å…¼å®¹æ—§ç‰ˆæœ¬å¯èƒ½æ²¡æœ‰ bases çš„æƒ…å†µ
                    baseCities = json.bases || [];

                    // å†™å…¥ LocalStorage
                    localStorage.setItem(DATA_KEY, JSON.stringify(travelData));
                    localStorage.setItem(TAGS_KEY, JSON.stringify(userTags));
                    localStorage.setItem('travel_map_bases_list', JSON.stringify(baseCities)); // æ³¨æ„è¿™é‡Œè¦ç”¨ä½ ä»£ç é‡Œå®šä¹‰çš„ BASE_KEY

                    alert("æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚");
                    location.reload(); // åˆ·æ–°é¡µé¢ä»¥é‡æ–°åŠ è½½æ•°æ®

                } catch (err) {
                    alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æŸåæˆ–æ ¼å¼é”™è¯¯ã€‚\n" + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- æ–°å¢ï¼šä¸“é—¨å¤„ç†ç›´è¾–å¸‚/æ¸¯æ¾³ç‚¹å‡»å½•å…¥çš„å‡½æ•° ---
        function openDirectCityModal(country, cityName, coord) {
            tempClickData = {
                country: country,
                province: cityName, // ç›´è¾–å¸‚çœä»½å³è‡ªèº«
                city: cityName,     // åŸå¸‚ä¹Ÿå­˜è‡ªèº«ï¼Œæˆ–è€…ç•™ç©ºï¼Œè§†ä¸ªäººä¹ æƒ¯ã€‚è¿™é‡Œå­˜è‡ªèº«æ–¹ä¾¿æ˜¾ç¤º
                lng: coord[0], lat: coord[1]
            };

            let loc = `${CN_MAP[country]} ${cityName}`;
            document.getElementById('loc-display').value = loc;
            document.getElementById('input-date').valueAsDate = new Date();
            document.getElementById('input-days').value = 1;
            document.getElementById('input-note').value = '';

            // é‡ç½®ç¼–è¾‘çŠ¶æ€
            editingIndex = null;
            document.getElementById('btn-delete').style.display = 'none';

            // ç”Ÿæˆæ ‡ç­¾
            const tagArea = document.getElementById('tag-selector-area');
            tagArea.innerHTML = '';
            userTags.forEach(tag => {
                let span = document.createElement('span');
                span.className = 'tag-option';
                span.innerText = tag;
                span.onclick = function () { this.classList.toggle('selected'); };
                tagArea.appendChild(span);
            });

            document.getElementById('modal-mask').style.display = 'block';
        }

        function renderProvince(pName, adcode) {
            currentLevel = 'province';
            currentScopeName = pName;
            updateBackButton(true, "â† è¿”å›ä¸­å›½", renderChina);

            myChart.showLoading();
            $.getJSON(`https://geo.datav.aliyun.com/areas_v3/bound/${adcode}_full.json`, function (geo) {
                myChart.hideLoading();
                echarts.registerMap(pName, geo);

                let regions = [];
                let points = [];

                geo.features.forEach(f => {
                    let city = f.properties.name;

                    // Baseåœ°ç€è‰²é€»è¾‘ ---
                    // é»˜è®¤æ ·å¼
                    let itemStyle = null;

                    // å¦‚æœæ˜¯ Base åœ°ï¼Œåº•è‰²è®¾ä¸ºæ©™è‰²
                    if (baseCities.includes(city)) {
                        itemStyle = {
                            areaColor: '#FF8C00', // Base æ©™è‰²
                            shadowBlur: 10, shadowColor: '#FF8C00'
                        };
                    }

                    // æ£€æŸ¥è¶³è¿¹è®°å½• (é€»è¾‘ï¼šBaseåœ°èƒŒæ™¯ä¼˜å…ˆï¼Œè¶³è¿¹ç‚¹ä¾ç„¶æ˜¾ç¤º)
                    let recs = travelData.filter(r => r.country === 'China' && r.province === pName && r.city === city);
                    if (recs.length > 0) {
                        // å¦‚æœä¸æ˜¯Baseåœ°ï¼Œæ‰åº”ç”¨å»è¿‡çš„äº®é»„è‰²ï¼›å¦‚æœæ˜¯Baseåœ°ï¼Œä¿æŒæ©™è‰²
                        if (!itemStyle) {
                            itemStyle = { areaColor: '#FFD700', shadowBlur: 10, shadowColor: '#FFD700' };
                        }
                        recs.forEach(r => points.push({ name: r.city, value: [r.lng, r.lat], custom: r }));
                    }

                    if (itemStyle) {
                        regions.push({ name: city, itemStyle: itemStyle });
                    }
                });

                let series = [{
                    type: 'scatter', coordinateSystem: 'geo', data: points,
                    symbol: 'circle', symbolSize: 12,
                    itemStyle: { color: '#ff3333', shadowBlur: 10, shadowColor: '#ff0000', borderColor: '#fff' }
                }];
                let opt = getCommonOption(pName, regions, series);
                opt.geo.label.show = true; // å¼ºåˆ¶æ˜¾ç¤ºæ ‡ç­¾
                myChart.setOption(opt, true);

                setupClickEvent('China', pName);
            });
        }

        function renderForeign(cName) {
            currentLevel = 'foreign';
            currentScopeName = cName;
            updateBackButton(true, "â† è¿”å›ä¸–ç•Œ", renderWorld);
            myChart.showLoading();
            $.getJSON(MAP_URLS[cName], function (geo) {
                myChart.hideLoading();
                echarts.registerMap(cName, geo);
                let regions = [];
                let points = [];
                geo.features.forEach(f => {
                    let state = f.properties.name;
                    let recs = travelData.filter(r => r.country === cName && r.province === state);
                    if (recs.length > 0) {
                        regions.push({ name: state, itemStyle: { areaColor: 'rgba(255, 215, 0, 0.4)' } });
                        recs.forEach(r => points.push({ name: r.province, value: [r.lng, r.lat], custom: r }));
                    }
                });
                let series = [{
                    type: 'scatter', coordinateSystem: 'geo', data: points,
                    symbol: 'circle', symbolSize: 12,
                    itemStyle: { color: '#ff3333', shadowBlur: 10, shadowColor: '#ff0000', borderColor: '#fff' }
                }];
                myChart.setOption(getCommonOption(cName, regions, series), true);
                setupClickEvent(cName, null);
            });
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function updateBackButton(show, text, handler) {
            const btn = document.getElementById('nav-back-btn');
            if (show) {
                btn.style.display = 'block';
                btn.innerText = text;
                btn.onclick = handler;
            } else {
                btn.style.display = 'none';
            }
        }
        function getHeatColor(count) {
            if (count >= 3) return 'rgba(255, 215, 0, 1.0)';
            if (count === 2) return 'rgba(255, 215, 0, 0.6)';
            if (count === 1) return 'rgba(255, 215, 0, 0.3)';
            return null;
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // --- æ–°å¢ï¼šåˆ‡æ¢ç¼–è¾‘æ¨¡å¼ ---
        function toggleEditMode() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.sidebar-edit-toggle');

            // åˆ‡æ¢ sidebar çš„ class
            sidebar.classList.toggle('edit-mode');

            // åˆ‡æ¢æŒ‰é’®è‡ªèº«çš„æ¿€æ´»æ ·å¼ï¼ˆé«˜äº®æ˜¾ç¤ºï¼Œæç¤ºå½“å‰å¤„äºç¼–è¾‘çŠ¶æ€ï¼‰
            toggleBtn.classList.toggle('active');
        }
        function updateStats() {
            document.getElementById('count-country').innerText = new Set(travelData.map(r => r.country)).size;
            document.getElementById('count-total').innerText = travelData.length;
        }

        // --- æ–°å¢ï¼šèƒŒæ™¯å…‰æ™•è·Ÿéšé¼ æ ‡é€»è¾‘ ---
        document.addEventListener('mousemove', function (e) {
            const cursorGlow = document.getElementById('cursor-glow');
            if (cursorGlow) {
                // ä½¿ç”¨ transform ç§»åŠ¨ï¼Œæ€§èƒ½æ›´å¥½
                cursorGlow.style.left = e.clientX + 'px';
                cursorGlow.style.top = e.clientY + 'px';
            }
        });

        // å¯åŠ¨
        window.addEventListener('resize', () => myChart.resize());
        // æ£€æµ‹ç™»å½•
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                currentUser = session.user;
                initCloudData();
            } else {
                // æœªç™»å½•å…ˆæ¸²æŸ“ç¦»çº¿æ•°æ®
                renderWorld(); updateLogSidebar(); updateStats();
                // å»¶æ—¶å¼¹å‡ºç™»å½•ï¼Œé¿å…è§†è§‰çªå…€
                setTimeout(() => document.getElementById('login-mask').style.display = 'flex', 500);
            }
        });

    </script>
</body>
</html>
