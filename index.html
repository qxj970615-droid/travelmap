<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¶³è¿¹åœ°å›¾ - æœ€ç»ˆå®Œæ•´ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- 1. èƒŒæ™¯å‡çº§ï¼šæå…‰ + ç½‘æ ¼ --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #050a14;
            font-family: "Microsoft YaHei", sans-serif; overflow: hidden;
            color: #fff;
        }
        .ambient-light {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 223, 255, 0.08), transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(80, 50, 250, 0.08), transparent 40%);
            filter: blur(50px); pointer-events: none;
        }
        .grid-texture {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px; pointer-events: none;
        }
        /* æ˜Ÿç©ºèƒŒæ™¯ (ä¿®å¤ç‰ˆï¼šéšæœºæ•£è½) */
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: transparent;
            background-image: 
                radial-gradient(2px 2px at 50px 100px, #ffffff, transparent),
                radial-gradient(2px 2px at 350px 50px, #ffffff, transparent),
                radial-gradient(2px 2px at 550px 500px, #ffffff, transparent),
                radial-gradient(2px 2px at 150px 450px, #ffffff, transparent),
                radial-gradient(2px 2px at 400px 300px, #ffffff, transparent),
                radial-gradient(1px 1px at 200px 200px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 100px 550px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 500px 250px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 300px 500px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 450px 100px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 50px 350px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 580px 50px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 250px 50px, rgba(255,255,255,0.7), transparent);
            background-repeat: repeat;
            background-size: 600px 600px;
            animation: moveStars 150s linear infinite; opacity: 0.9; pointer-events: none;
        }
        @keyframes moveStars { from {transform: translateY(0);} to {transform: translateY(-1000px);} }
        
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* --- 2. å·¦ä¾§é¢æ¿ --- */
        .left-panel { position: absolute; top: 30px; left: 30px; z-index: 10; pointer-events: none; }
        .main-title h1 {
            margin: 0; font-size: 34px; letter-spacing: 2px;
            background: linear-gradient(135deg, #fff 0%, #00dfff 100%);
            -webkit-background-clip: text; color: transparent;
            text-shadow: 0 0 30px rgba(0, 223, 255, 0.4);
        }
        
        /* æŒ‰é’®ç»„ */
        .btn-group-left { margin-top: 20px; pointer-events: auto; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
        .nav-btn, .tag-manage-btn {
            background: rgba(16, 30, 50, 0.6); backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 223, 255, 0.3); color: #fff;
            padding: 6px 18px; border-radius: 6px; cursor: pointer; font-size: 13px;
            transition: 0.3s; display: flex; align-items: center; gap: 5px;
        }
        .nav-btn:hover, .tag-manage-btn:hover {
            background: rgba(0, 223, 255, 0.2); border-color: #00dfff;
            box-shadow: 0 0 15px rgba(0, 223, 255, 0.3);
        }

        /* --- 3. ä¾§è¾¹æ ä¸å¡ç‰‡ --- */
        .sidebar-btn {
            position: absolute; top: 30px; right: 20px; z-index: 100;
            width: 40px; height: 40px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .sidebar-btn:hover { background: rgba(255,255,255,0.15); border-color: #fff; }

        .sidebar {
            position: absolute; top: 0; right: 0; bottom: 0; width: 360px;
            background: rgba(10, 16, 26, 0.95); backdrop-filter: blur(15px);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            transform: translateX(100%); transition: transform 0.4s ease;
            z-index: 90; display: flex; flex-direction: column; padding-top: 80px;
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header {
            padding: 0 20px 10px; font-size: 16px; color: #00dfff; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px 20px; }
        
        .year-header {
            color: #fff; font-weight: bold; padding: 12px 5px; margin-top: 15px; font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer;
            display: flex; justify-content: space-between; align-items: baseline;
        }
        .year-stats { font-size: 12px; color: #678; font-weight: normal; }

        /* ç»Ÿè®¡å°é¢æ¿ */
        .year-summary-box {
            display: none; background: rgba(0, 0, 0, 0.4); margin: 0 5px 10px 5px; padding: 10px;
            border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05); font-size: 12px;
            animation: slideDown 0.2s ease-out;
        }
        .summary-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); }
        .summary-row:last-child { border-bottom: none; }
        .sum-title { font-weight: bold; } .sum-data { font-family: monospace; color: #fff; }
        .sum-hike { color: #50c878; } .sum-dive { color: #00dfff; } .sum-run { color: #ffaa00; }

        /* å¡ç‰‡æ ·å¼ */
        .record-list.hidden { display: none; }
        .record-item {
            position: relative; background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 10px;
            padding: 12px 15px; margin-bottom: 12px; overflow: hidden;
            transition: all 0.3s ease; border-left: 3px solid rgba(255,255,255,0.2);
        }
        .record-item:hover {
            transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.3);
        }
        .rec-bg-img {
            position: absolute; top: 0; right: 0; width: 70%; height: 100%;
            background-size: cover; background-position: center; opacity: 0.6; filter: grayscale(30%);
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 90%);
            mask-image: linear-gradient(to right, transparent 0%, black 90%);
            z-index: 0; transition: 0.5s;
        }
        .record-item:hover .rec-bg-img { opacity: 0.9; filter: grayscale(0%); transform: scale(1.05); }
        
        .rec-content { position: relative; z-index: 1; width: 100%; }
        .rec-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .rec-place { font-size: 15px; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.8); display: flex; align-items: center;}
        .flag-icon { width: 18px; height: 13px; margin-right: 6px; border-radius: 2px; box-shadow: 0 0 3px rgba(0,0,0,0.5); }
        .rec-date { font-size: 12px; color: rgba(255,255,255,0.7); display: block; margin-bottom: 0; }
        .rec-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .rec-tag-badge { 
            padding: 1px 6px; border-radius: 4px; font-size: 10px;
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); 
            color: #ddd; backdrop-filter: blur(2px);
        }
        .rec-days { position: absolute; bottom: 10px; right: 10px; font-size: 18px; font-weight: 900; color: rgba(255,255,255,0.2); z-index: 1; }

        /* ç¼–è¾‘æŒ‰é’® */
        .sidebar-edit-toggle {
            position: absolute; top: 80px; right: 20px; z-index: 100;
            width: 40px; height: 40px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #aaa;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
        }
        .sidebar-edit-toggle.active { background: #00dfff; color: #000; border-color: #00dfff; }
        .btn-edit-rec { display: none; cursor: pointer; color: #00dfff; margin-left: 10px; font-size: 14px; text-shadow: 0 0 5px black;}
        .sidebar.edit-mode .btn-edit-rec { display: inline-block; }

        /* åŒºåŸŸç­›é€‰æŒ‰é’® */
        .region-record-btn {
            position: absolute; top: 130px; right: 20px; z-index: 100;
            width: 40px; height: 40px; background: rgba(255, 165, 0, 0.15);
            border: 1px solid #FFD700; border-radius: 50%; color: #FFD700;
            display: none; align-items: center; justify-content: center; cursor: pointer; 
            font-size: 18px; transition: 0.3s; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        .region-record-btn:hover { background: #FFD700; color: #000; box-shadow: 0 0 20px #FFD700; transform: scale(1.1); }

        /* --- 4. ç»Ÿè®¡ä¸å›¾ä¾‹ --- */
        .stats-panel { position: absolute; top: 30px; right: 80px; z-index: 10; display: flex; gap: 15px; pointer-events: none; }
        .stat-card {
            background: rgba(16, 30, 50, 0.7); backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1); padding: 8px 20px; border-radius: 8px; text-align: center;
        }
        .stat-num { font-size: 24px; color: #FFD700; font-weight: bold; display: block; }
        .stat-desc { font-size: 12px; color: #88aadd; }

        .legend-box {
            position: absolute; bottom: 30px; left: 30px; z-index: 10;
            background: rgba(0,0,0,0.6); padding: 12px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1); pointer-events: none;
        }
        .legend-row { display: flex; align-items: center; margin-bottom: 5px; font-size: 12px; color: #ccc; }
        .color-dot { width: 10px; height: 10px; margin-right: 8px; border-radius: 2px; }

        /* --- 5. å¼¹çª—é€šç”¨æ ·å¼ --- */
        .modal-mask, #modal-mask, #tag-manager-mask, #base-manager-mask { 
            display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 2000; backdrop-filter: blur(5px); 
        }
        .modal {
            background: rgba(20, 30, 45, 0.95); margin: 5% auto; padding: 25px; width: 380px;
            border: 1px solid rgba(0, 223, 255, 0.3); border-radius: 12px; 
            box-shadow: 0 0 40px rgba(0, 223, 255, 0.2); color: #fff;
        }
        .form-item { margin-bottom: 15px; }
        .form-item label { display: block; color: #8ab; font-size: 12px; margin-bottom: 5px; }
        .form-item input, .form-item textarea {
            width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #345;
            color: #fff; border-radius: 4px; box-sizing: border-box; outline: none;
        }
        .modal-btns { text-align: right; margin-top: 20px; }
        .btn-ok { background: #00dfff; color: #000; border: none; padding: 6px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: transparent; border: 1px solid #666; color: #ccc; padding: 6px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn-del { float: left; background: transparent; border: 1px solid #ff4444; color: #ff4444; padding: 6px 15px; border-radius: 4px; cursor: pointer; display: none; }

        /* æ ‡ç­¾é€‰æ‹©å™¨ */
        .tag-selector-container { display: flex; flex-wrap: wrap; gap: 8px; padding: 5px 0; }
        .tag-option { padding: 4px 10px; border: 1px solid #445; border-radius: 15px; font-size: 12px; cursor: pointer; color: #aaa; transition: 0.2s; }
        .tag-option.selected { background: rgba(0, 223, 255, 0.2); border-color: #00dfff; color: #fff; }
        
        /* åŠ¨æ€æ•°æ®è¾“å…¥æ¡† */
        .dynamic-data-row { display: none; gap: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; }
        .dynamic-data-row.active { display: flex; animation: slideDown 0.3s; }
        .dynamic-input-group { flex: 1; }
        .dynamic-input-group label { color: #00dfff; font-size: 12px; display: block; margin-bottom: 4px;}
        .dynamic-input-group input { text-align: center; color: #000 !important; background: #fff !important; font-weight: bold; border-radius: 4px;}

        /* ç®¡ç†åˆ—è¡¨ */
        .tag-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .tag-list-manage { max-height: 200px; overflow-y: auto; border: 1px solid #334; padding: 10px; border-radius: 4px; background: rgba(0,0,0,0.2); }
        .manage-tag-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px dashed #334; font-size: 13px; }
        .btn-del-tag { color: #ff4444; cursor: pointer; font-size: 12px; }

        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

    <!-- èƒŒæ™¯ç‰¹æ•ˆ -->
    <div class="ambient-light"></div>
    <div class="grid-texture"></div>
    <div class="stars"></div>

    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="left-panel">
        <div class="main-title">
            <h1>æˆ‘çš„è¶³è¿¹åœ°å›¾</h1>
            <!-- ç‰ˆæœ¬å· -->
            <div style="position:relative; display:inline-block; margin-top:5px; pointer-events:auto;" class="version-container">
                <div style="padding:2px 8px; border:1px solid #00dfff; border-radius:4px; color:#00dfff; font-size:11px; cursor:help; background:rgba(0,223,255,0.1);">V3.8 Stable</div>
            </div>
        </div>
        <div class="btn-group-left">
            <button id="nav-back-btn" class="nav-btn" style="display:none;">â† è¿”å›</button>
            <div style="display:flex; gap:10px;">
                <button class="tag-manage-btn" onclick="openTagManager()">ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</button>
                <button class="tag-manage-btn" style="border-color:#FF8C00; color:#FF8C00;" onclick="openBaseManager()">ğŸ  Baseåœ°</button>
            </div>
            
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed rgba(255,255,255,0.2); width: 100%;">
                <button class="nav-btn" style="display:inline-block; font-size:12px; padding:5px 12px; opacity:0.8;" onclick="exportData()">â¬‡ å¤‡ä»½</button>
                <button class="nav-btn" style="display:inline-block; font-size:12px; padding:5px 12px; opacity:0.8;" onclick="document.getElementById('file-input').click()">â¬† æ¢å¤</button>
                <input type="file" id="file-input" style="display: none;" onchange="importData(this)">
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡ -->
    <div class="stats-panel">
        <div class="stat-card"><span class="stat-num" id="count-country">0</span><span class="stat-desc">å›½å®¶/åœ°åŒº</span></div>
        <div class="stat-card"><span class="stat-num" id="count-total">0</span><span class="stat-desc">è¶³è¿¹æ€»æ•°</span></div>
    </div>

    <!-- å›¾ä¾‹ -->
    <div class="legend-box">
        <div class="legend-row"><div class="color-dot" style="background:rgba(255, 215, 0, 0.3)"></div>è¶³è¿¹åˆæ¢ (1å¤„)</div>
        <div class="legend-row"><div class="color-dot" style="background:rgba(255, 215, 0, 0.6)"></div>æ·±åº¦æ¸¸è§ˆ (2å¤„)</div>
        <div class="legend-row"><div class="color-dot" style="background:rgba(255, 215, 0, 1.0); box-shadow:0 0 5px gold;"></div>å®Œå…¨æ¢ç´¢ (3å¤„+)</div>
    </div>

    <!-- ä¾§è¾¹æ æ§ä»¶ -->
    <div class="sidebar-btn" onclick="toggleSidebar()">â˜°</div>
    <div class="sidebar-edit-toggle" onclick="toggleEditMode()" title="ç¼–è¾‘æ¨¡å¼">âœ</div>
    <div id="region-filter-btn" class="region-record-btn" title="æŸ¥çœ‹å½“å‰åŒºåŸŸè®°å½•">ğŸ“–</div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">æ—…è¡Œæ—¥å¿— (å½’æ¡£)</div>
        <div class="sidebar-content" id="log-container"></div>
    </div>

    <div id="map-container"></div>

    <!-- å½•å…¥å¼¹çª— -->
    <div id="modal-mask" class="modal-mask">
        <div class="modal">
            <h3 style="margin-top:0; color:#00dfff; border-bottom:1px solid #334; padding-bottom:10px;">è®°å½•ç¾å¥½æ—…ç¨‹</h3>
            <div class="form-item">
                <label>ä½ç½®</label>
                <input type="text" id="loc-display" readonly style="color:#FFD700; font-weight:bold; border:none; padding-left:0; background:transparent;">
            </div>
            <div class="form-item" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="input-date">
                </div>
                <div style="width:80px;">
                    <label>å¤©æ•°</label>
                    <input type="number" id="input-days" value="1" min="1" style="text-align:center;">
                </div>
            </div>
            <div class="form-item">
                <label>é€‰æ‹©æ ‡ç­¾ (å¤šé€‰)</label>
                <div class="tag-selector-container" id="tag-selector-area"></div>
            </div>
            
            <!-- åŠ¨æ€æ•°æ® -->
            <div id="data-hike-run" class="dynamic-data-row">
                <div class="dynamic-input-group"><label>ğŸ“ è·ç¦»(km)</label><input type="number" id="input-distance" step="0.1"></div>
                <div class="dynamic-input-group"><label>â›°ï¸ çˆ¬å‡(m)</label><input type="number" id="input-climb"></div>
            </div>
            <div id="data-dive" class="dynamic-data-row">
                <div class="dynamic-input-group"><label>ğŸ¤¿ æ°”ç“¶æ•°</label><input type="number" id="input-dives"></div>
            </div>
            <div id="data-ski" class="dynamic-data-row">
                <div class="dynamic-input-group"><label>â›·ï¸ æ»‘é›ªé‡Œç¨‹(km)</label><input type="number" id="input-ski-dist" step="0.1"></div>
            </div>

            <div class="form-item">
                <label>å¤‡æ³¨</label>
                <textarea id="input-note" rows="2"></textarea>
            </div>
            <div class="modal-btns">
                <button id="btn-delete" class="btn-del" onclick="deleteRecord()">åˆ é™¤</button>
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-ok" onclick="saveRecord()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ ‡ç­¾ç®¡ç†å¼¹çª— -->
    <div id="tag-manager-mask" class="modal-mask">
        <div class="modal">
            <h3 style="margin-top:0; color:#FFD700; border-bottom:1px solid #334; padding-bottom:10px;">æ ‡ç­¾ç®¡ç†</h3>
            <div class="tag-input-group">
                <input type="text" id="new-tag-name" placeholder="æ–°æ ‡ç­¾å">
                <button class="btn-ok" onclick="addNewTag()" style="padding:5px 15px;">æ·»åŠ </button>
            </div>
            <div class="form-item">
                <label>å·²æœ‰æ ‡ç­¾</label>
                <div class="tag-list-manage" id="manage-tag-list"></div>
            </div>
            <div class="modal-btns"><button class="btn-cancel" onclick="closeTagManager()">å…³é—­</button></div>
        </div>
    </div>

<!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
    <div id="login-mask" class="modal-mask" style="display:flex;"> <!-- é»˜è®¤æ˜¾ç¤º -->
        <div class="modal" style="text-align:center;">
            <h2 style="color:#00dfff; margin-bottom:20px;">ğŸŒ å¼€å¯äº‘ç«¯æ—…ç¨‹</h2>
            <div class="form-item">
                <input type="email" id="email" placeholder="é‚®ç®±åœ°å€" style="text-align:left;">
            </div>
            <div class="form-item">
                <input type="password" id="password" placeholder="å¯†ç " style="text-align:left;">
            </div>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn-ok" onclick="handleLogin()">ç™»å½•</button>
                <button class="nav-btn" style="display:inline-block;" onclick="handleSignUp()">æ³¨å†Œ</button>
            </div>
            <p id="login-msg" style="color:#ff4444; font-size:12px; margin-top:10px;"></p>
            <div style="margin-top:15px; border-top:1px dashed #334; padding-top:10px;">
                <span style="font-size:12px; color:#888; cursor:pointer;" onclick="useOfflineMode()">æš‚ä¸ç™»å½•ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼ &gt;</span>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·çŠ¶æ€æ  (æ·»åŠ åœ¨å·¦ä¾§é¢æ¿æŒ‰é’®ç»„çš„æœ€ä¸Šæ–¹) -->
    <!-- è¯·å°†æ­¤ä»£ç æ’å…¥åˆ° class="btn-group-left" çš„æœ€å¼€å§‹ä½ç½® -->
    <div id="user-status" style="margin-bottom:10px; font-size:12px; color:#00dfff; display:none;">
        ğŸ‘¤ <span id="user-email"></span> 
        <a href="#" onclick="handleLogout()" style="color:#888; margin-left:5px;">[é€€å‡º]</a>
    </div>

    <!-- Baseç®¡ç†å¼¹çª— -->
    <div id="base-manager-mask" class="modal-mask">
        <div class="modal">
            <h3 style="margin-top:0; color:#FF8C00; border-bottom:1px solid #334; padding-bottom:10px;">Baseåœ°ç®¡ç†</h3>
            <div class="tag-input-group">
                <input type="text" id="new-base-name" placeholder="åŸå¸‚åï¼Œå¦‚ï¼šä¸Šæµ·å¸‚">
                <button class="btn-ok" onclick="addNewBase()" style="padding:5px 15px; background:#FF8C00;">æ·»åŠ </button>
            </div>
            <div class="form-item">
                <label>å·²æœ‰Base</label>
                <div class="tag-list-manage" id="manage-base-list"></div>
            </div>
            <div class="modal-btns"><button class="btn-cancel" onclick="closeBaseManager()">å…³é—­</button></div>
        </div>
    </div>

<script>
// --- Supabase é…ç½® ---
    const SUPABASE_URL = 'https://kyslslgfyzunyxpcxody.supabase.co'; // æ›¿æ¢ä¸ºä½ çš„ Project URL
    const SUPABASE_KEY = 'sb_publishable_NNtPZSWmyqZiewuAqnjpvA_TEsm9p52'; // æ›¿æ¢ä¸ºä½ çš„ anon public Key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let currentUser = null;
    const chartDom = document.getElementById('map-container');
    const myChart = echarts.init(chartDom);
    const DATA_KEY = 'travel_map_data_pro';
    const TAGS_KEY = 'travel_map_tags_list';
    const BASE_KEY = 'travel_map_bases_list';

    let travelData = JSON.parse(localStorage.getItem(DATA_KEY)) || [];
    let userTags = JSON.parse(localStorage.getItem(TAGS_KEY)) || ['è¶Šé‡è·‘', 'è¶Šé‡è·‘è®­ç»ƒ', 'æ»‘é›ª', 'å¾’æ­¥', 'æ½œæ°´', 'è§‚æ˜Ÿ', 'æ‘„å½±', 'è‡ªé©¾', 'ç¾é£Ÿ', 'åšç‰©é¦†'];
    let baseCities = JSON.parse(localStorage.getItem(BASE_KEY)) || [];
    let editingIndex = null;
    let tempClickData = null;
    let currentLevel = 'world'; 
    let currentScopeName = '';

    // å­—å…¸
    const CN_MAP = {'China':'ä¸­å›½','United States':'ç¾å›½','Russia':'ä¿„ç½—æ–¯','Japan':'æ—¥æœ¬','Australia':'æ¾³å¤§åˆ©äºš','Canada':'åŠ æ‹¿å¤§','United Kingdom':'è‹±å›½','France':'æ³•å›½','Germany':'å¾·å›½','Italy':'æ„å¤§åˆ©','Spain':'è¥¿ç­ç‰™','South Korea':'éŸ©å›½','North Korea':'æœé²œ','India':'å°åº¦','Thailand':'æ³°å›½','Philippines':'è²å¾‹å®¾','Indonesia':'å°åº¦å°¼è¥¿äºš','Malaysia':'é©¬æ¥è¥¿äºš','Vietnam':'è¶Šå—','Singapore':'æ–°åŠ å¡','Cambodia':'æŸ¬åŸ”å¯¨','Laos':'è€æŒ','Myanmar':'ç¼…ç”¸','Brazil':'å·´è¥¿','Argentina':'é˜¿æ ¹å»·','Mexico':'å¢¨è¥¿å“¥','Egypt':'åŸƒåŠ','South Africa':'å—é','Turkey':'åœŸè€³å…¶','Netherlands':'è·å…°','Switzerland':'ç‘å£«','Sweden':'ç‘å…¸','Norway':'æŒªå¨','Finland':'èŠ¬å…°','Denmark':'ä¸¹éº¦','New Zealand':'æ–°è¥¿å…°','United Arab Emirates':'é˜¿è”é…‹','Saudi Arabia':'æ²™ç‰¹é˜¿æ‹‰ä¼¯','Portugal':'è‘¡è„ç‰™','Greece':'å¸Œè…Š','Austria':'å¥¥åœ°åˆ©','Hungary':'åŒˆç‰™åˆ©','Czech Republic':'æ·å…‹','Oman':'é˜¿æ›¼','Jordan':'çº¦æ—¦','Iran':'ä¼Šæœ—','Kazakhstan':'å“ˆè¨å…‹æ–¯å¦','Uzbekistan':'ä¹Œå…¹åˆ«å…‹æ–¯å¦','Armenia':'äºšç¾å°¼äºš','Azerbaijan':'é˜¿å¡æ‹œç–†','Georgia':'æ ¼é²å‰äºš','Maldives':'é©¬å°”ä»£å¤«','Ethiopia':'åŸƒå¡ä¿„æ¯”äºš','Tanzania':'å¦æ¡‘å°¼äºš','Kenya':'è‚¯å°¼äºš','Rwanda':'å¢æ—ºè¾¾','Nepal':'å°¼æ³Šå°”'};
    const COUNTRY_ISO = {'China':'cn','United States':'us','Russia':'ru','Japan':'jp','Australia':'au','Canada':'ca','United Kingdom':'gb','France':'fr','Germany':'de','Italy':'it','Spain':'es','South Korea':'kr','Thailand':'th','Philippines':'ph','Indonesia':'id','Malaysia':'my','Vietnam':'vn','Singapore':'sg','Brazil':'br','Argentina':'ar','Egypt':'eg','Turkey':'tr','Netherlands':'nl','Switzerland':'ch','Sweden':'se','New Zealand':'nz','Austria':'at','Hungary':'hu','Czech Republic':'cz','Oman':'om','Jordan':'jo','Iran':'ir','Kazakhstan':'kz','Uzbekistan':'uz','Maldives':'mv','Ethiopia':'et','Tanzania':'tz','Kenya':'ke','Rwanda':'rw','Nepal':'np'};
    const CHINA_PROVINCES = {'China':100000,'åŒ—äº¬å¸‚':110000,'å¤©æ´¥å¸‚':120000,'æ²³åŒ—çœ':130000,'å±±è¥¿çœ':140000,'å†…è’™å¤è‡ªæ²»åŒº':150000,'è¾½å®çœ':210000,'å‰æ—çœ':220000,'é»‘é¾™æ±Ÿçœ':230000,'ä¸Šæµ·å¸‚':310000,'æ±Ÿè‹çœ':320000,'æµ™æ±Ÿçœ':330000,'å®‰å¾½çœ':340000,'ç¦å»ºçœ':350000,'æ±Ÿè¥¿çœ':360000,'å±±ä¸œçœ':370000,'æ²³å—çœ':410000,'æ¹–åŒ—çœ':420000,'æ¹–å—çœ':430000,'å¹¿ä¸œçœ':440000,'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº':450000,'æµ·å—çœ':460000,'é‡åº†å¸‚':500000,'å››å·çœ':510000,'è´µå·çœ':520000,'äº‘å—çœ':530000,'è¥¿è—è‡ªæ²»åŒº':540000,'é™•è¥¿çœ':610000,'ç”˜è‚ƒçœ':620000,'é’æµ·çœ':630000,'å®å¤å›æ—è‡ªæ²»åŒº':640000,'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº':650000,'å°æ¹¾çœ':710000,'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº':810000,'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº':820000};
    const NO_DRILL_LIST = ['åŒ—äº¬å¸‚', 'å¤©æ´¥å¸‚', 'ä¸Šæµ·å¸‚', 'é‡åº†å¸‚', 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº', 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº'];
    const MAP_URLS = { world: 'https://code.highcharts.com/mapdata/custom/world.geo.json','Thailand':'https://code.highcharts.com/mapdata/countries/th/th-all.geo.json','Vietnam':'https://code.highcharts.com/mapdata/countries/vn/vn-all.geo.json','Malaysia':'https://code.highcharts.com/mapdata/countries/my/my-all.geo.json','Indonesia':'https://code.highcharts.com/mapdata/countries/id/id-all.geo.json','Philippines':'https://code.highcharts.com/mapdata/countries/ph/ph-all.geo.json','United States':'https://code.highcharts.com/mapdata/countries/us/us-all.geo.json','Japan':'https://code.highcharts.com/mapdata/countries/jp/jp-all.geo.json','United Kingdom':'https://code.highcharts.com/mapdata/countries/gb/gb-all.geo.json','France':'https://code.highcharts.com/mapdata/countries/fr/fr-all.geo.json','Germany':'https://code.highcharts.com/mapdata/countries/de/de-all.geo.json','Italy':'https://code.highcharts.com/mapdata/countries/it/it-all.geo.json','Spain':'https://code.highcharts.com/mapdata/countries/es/es-all.geo.json','Russia':'https://code.highcharts.com/mapdata/countries/ru/ru-all.geo.json','Australia':'https://code.highcharts.com/mapdata/countries/au/au-all.geo.json','Canada':'https://code.highcharts.com/mapdata/countries/ca/ca-all.geo.json','Switzerland':'https://code.highcharts.com/mapdata/countries/ch/ch-all.geo.json','Turkey':'https://code.highcharts.com/mapdata/countries/tr/tr-all.geo.json','Egypt':'https://code.highcharts.com/mapdata/countries/eg/eg-all.geo.json','New Zealand':'https://code.highcharts.com/mapdata/countries/nz/nz-all.geo.json','South Korea':'https://code.highcharts.com/mapdata/countries/kr/kr-all.geo.json','Hungary':'https://code.highcharts.com/mapdata/countries/hu/hu-all.geo.json','Czech Republic':'https://code.highcharts.com/mapdata/countries/cz/cz-all.geo.json','Austria':'https://code.highcharts.com/mapdata/countries/at/at-all.geo.json','Oman':'https://code.highcharts.com/mapdata/countries/om/om-all.geo.json','Jordan':'https://code.highcharts.com/mapdata/countries/jo/jo-all.geo.json','Iran':'https://code.highcharts.com/mapdata/countries/ir/ir-all.geo.json','Kazakhstan':'https://code.highcharts.com/mapdata/countries/kz/kz-all.geo.json','Uzbekistan':'https://code.highcharts.com/mapdata/countries/uz/uz-all.geo.json','Armenia':'https://code.highcharts.com/mapdata/countries/am/am-all.geo.json','Azerbaijan':'https://code.highcharts.com/mapdata/countries/az/az-all.geo.json','Georgia':'https://code.highcharts.com/mapdata/countries/ge/ge-all.geo.json','Maldives':'https://code.highcharts.com/mapdata/countries/mv/mv-all.geo.json','Ethiopia':'https://code.highcharts.com/mapdata/countries/et/et-all.geo.json','Tanzania':'https://code.highcharts.com/mapdata/countries/tz/tz-all.geo.json','Kenya':'https://code.highcharts.com/mapdata/countries/ke/ke-all.geo.json','Rwanda':'https://code.highcharts.com/mapdata/countries/rw/rw-all.geo.json','Nepal':'https://code.highcharts.com/mapdata/countries/np/np-all.geo.json' };

    // --- ä¾§è¾¹æ æ¸²æŸ“ (å¸¦ç­›é€‰) ---
    function updateLogSidebar(filterObj = null) {
        const container = document.getElementById('log-container');
        container.innerHTML = '';
        
        let filteredData = travelData.map((item, index) => ({...item, originalIndex: index}));
        if (filterObj) {
            filteredData = filteredData.filter(r => filterObj.province ? (r.country === filterObj.country && r.province === filterObj.province) : r.country === filterObj.country);
            let title = filterObj.province ? filterObj.province : (CN_MAP[filterObj.country] || filterObj.country);
            document.querySelector('#sidebar .sidebar-header').innerHTML = `${title} <span style="font-size:12px;cursor:pointer;color:#aaa;" onclick="resetSidebar()">[æ˜¾ç¤ºå…¨éƒ¨]</span>`;
        } else {
            document.querySelector('#sidebar .sidebar-header').innerHTML = 'æ—…è¡Œæ—¥å¿— (å½’æ¡£)';
        }

        if (filteredData.length === 0) { container.innerHTML = '<div style="color:#888; text-align:center; margin-top:20px;">æš‚æ— è®°å½•</div>'; return; }

        let groups = {};
        filteredData.forEach(r => { let y = r.date.substring(0,4)||'æœªçŸ¥'; if(!groups[y]) groups[y]=[]; groups[y].push(r); });

        Object.keys(groups).sort((a,b)=>b-a).forEach(year => {
            let recs = groups[year].sort((a,b) => new Date(b.date)-new Date(a.date));
            let totalDays = recs.reduce((sum, r) => sum + (parseInt(r.days)||1), 0);

            let stats = { hike: { count: 0, dist: 0, climb: 0 }, dive: { count: 0 }, run:  { count: 0, dist: 0, climb: 0 } };
            recs.forEach(r => {
                const tStr = (r.tags||[]).join(',');
                if (tStr.includes('å¾’æ­¥')) { stats.hike.count++; stats.hike.dist+=parseFloat(r.distance)||0; stats.hike.climb+=parseFloat(r.climb)||0; }
                if (tStr.includes('æ½œæ°´')) { stats.dive.count+=parseFloat(r.dives)||0; }
                if (tStr.includes('è¶Šé‡è·‘')) { stats.run.count++; stats.run.dist+=parseFloat(r.distance)||0; stats.run.climb+=parseFloat(r.climb)||0; }
            });

            let statsContent = '';
            if (stats.hike.count > 0) statsContent += `<div class="summary-row sum-hike"><span class="sum-title">ğŸš¶ å¾’æ­¥ (${stats.hike.count}æ¬¡)</span><span class="sum-data">${stats.hike.dist.toFixed(1)}km / ${stats.hike.climb}m</span></div>`;
            if (stats.run.count > 0) statsContent += `<div class="summary-row sum-run"><span class="sum-title">ğŸƒ è¶Šé‡è·‘ (${stats.run.count}æ¬¡)</span><span class="sum-data">${stats.run.dist.toFixed(1)}km / ${stats.run.climb}m</span></div>`;
            if (stats.dive.count > 0) statsContent += `<div class="summary-row sum-dive"><span class="sum-title">ğŸ¤¿ æ½œæ°´</span><span class="sum-data">ç´¯è®¡ ${stats.dive.count} ç“¶</span></div>`;
            
            let summaryDiv = document.createElement('div');
            if (statsContent) summaryDiv.innerHTML = `<div class="year-summary-box">${statsContent}</div>`;

            let header = document.createElement('div');
            header.className = 'year-header';
            header.innerHTML = `<span>${year}</span> <span class="year-stats">${recs.length} æ¬¡ / ${totalDays} å¤©</span>`;
            
            let list = document.createElement('div');
            list.className = 'record-list';
            list.style.display = filterObj ? 'block' : 'none'; // ç­›é€‰æ—¶é»˜è®¤å±•å¼€
            if (filterObj && statsContent) setTimeout(() => { if(summaryDiv.firstChild) summaryDiv.firstChild.style.display = 'block'; },0);

            recs.forEach(r => {
                let div = document.createElement('div');
                div.className = 'record-item';
                
                let bgUrl = ''; let borderColor = '';
                if (r.tags && r.tags.length > 0) {
                    const t = r.tags.join(',');
                    if (t.includes('è¶Šé‡è·‘')) { bgUrl = 'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=400'; borderColor = '#ffaa00'; }
                    else if (t.includes('æ»‘é›ª')) { bgUrl = 'https://images.unsplash.com/photo-1551698618-1dfe5d97d256?q=80&w=400'; borderColor = '#00dfff'; }
                    else if (t.includes('æ½œæ°´')) { bgUrl = 'https://images.unsplash.com/photo-1544551763-46a013bb70d5?q=80&w=400'; borderColor = '#0055ff'; }
                    else if (t.includes('è§‚æ˜Ÿ')) { bgUrl = 'https://images.unsplash.com/photo-1506703719100-a0f3a48c0f86?q=80&w=400'; borderColor = '#9933ff'; }
                    else if (t.includes('å¾’æ­¥')) { bgUrl = 'https://images.unsplash.com/photo-1551632811-561732d1e306?q=80&w=400'; borderColor = '#50c878'; }
                    else if (t.includes('æ‘„å½±')) { bgUrl = 'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?q=80&w=400'; borderColor = '#ccc'; }
                    else if (t.includes('è‡ªé©¾')) { bgUrl = 'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=400'; borderColor = '#FFD700'; }
                    else if (t.includes('ç¾é£Ÿ')) { bgUrl = 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=400'; borderColor = '#ff4444'; }
                    else if (t.includes('åšç‰©é¦†')) { bgUrl = 'https://images.unsplash.com/photo-1565060169389-758fa716283b?q=80&w=400'; borderColor = '#eebb44'; }
                }
                if (borderColor) div.style.borderLeftColor = borderColor;

                let statsHtml = '';
                let parts = [];
                if (r.distance) parts.push(`ğŸ“ ${r.distance}km`);
                if (r.climb) parts.push(`â›°ï¸ ${r.climb}m`);
                if (r.dives) parts.push(`ğŸ¤¿ ${r.dives}ç“¶`);
                if (r.skiDist) parts.push(`â›·ï¸ ${r.skiDist}km`);
                if (parts.length > 0) statsHtml = `<div style="margin-top:4px; font-size:11px; color:#FFD700; text-shadow: 0 1px 2px black;">${parts.join(' &nbsp;|&nbsp; ')}</div>`;

                let noteHtml = '';
                if (r.note && r.note.trim() !== '') noteHtml = `<div style="margin-top:6px; padding-top:4px; border-top:1px dashed rgba(255,255,255,0.15); font-size:12px; color:#aab; font-style:italic; line-height:1.4;">${r.note}</div>`;

                let cn = CN_MAP[r.country] || r.country;
                let place = cn + (r.city ? ` Â· ${r.city}` : ` Â· ${r.province}`);
                let tagsHtml = ''; if(r.tags) r.tags.forEach(t => tagsHtml += `<span class="rec-tag-badge">${t}</span>`);
                let iso = COUNTRY_ISO[r.country] ? COUNTRY_ISO[r.country].toLowerCase() : null;
                let flagImg = iso ? `<img src="https://flagcdn.com/w40/${iso}.png" class="flag-icon">` : '';
                let bgDiv = bgUrl ? `<div class="rec-bg-img" style="background-image: url('${bgUrl}');"></div>` : '';

                div.innerHTML = `
                    ${bgDiv}
                    <div class="rec-content">
                        <div class="rec-top">
                            <div style="display:flex; align-items:center;">${flagImg} <span>${place}</span></div>
                            <span class="btn-edit-rec" onclick="editRecord(${r.originalIndex})">âœ</span>
                        </div>
                        <div style="display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:5px;">
                            <span class="rec-date" style="margin-bottom:0;">${r.date}</span>
                            <div class="rec-tags">${tagsHtml}</div>
                        </div>
                        ${statsHtml}
                        ${noteHtml}
                    </div>
                    <span class="rec-days">${r.days || 1}d</span>
                `;
                list.appendChild(div);
            });

            header.onclick = function() {
                const sumBox = summaryDiv.querySelector('.year-summary-box');
                if (list.style.display === 'none') {
                    list.style.display = 'block';
                    if(sumBox) sumBox.style.display = 'block';
                } else {
                    list.style.display = 'none';
                    if(sumBox) sumBox.style.display = 'none';
                }
            };
            container.appendChild(header);
            container.appendChild(summaryDiv);
            container.appendChild(list);
        });
    }

    function resetSidebar() { updateLogSidebar(null); }

    // --- åœ°å›¾æ¸²æŸ“ ---
    function renderWorld() {
        currentLevel = 'world';
        updateBackButton(false);
        document.getElementById('region-filter-btn').style.display = 'none';
        updateLogSidebar(null); 
        myChart.clear();
        myChart.showLoading({ text: 'åŠ è½½ä¸–ç•Œåœ°å›¾...', color: '#00dfff', maskColor: 'rgba(0,0,0,0.5)' });

        $.getJSON(MAP_URLS.world, function(geo) {
            myChart.hideLoading();
            echarts.registerMap('world', geo);
            let regions = [];
            geo.features.forEach(f => {
                let name = f.properties.name;
                let count = new Set(travelData.filter(r => r.country === name).map(r => r.province)).size;
                let color = getHeatColor(count);
                if (color) regions.push({ name: name, itemStyle: { areaColor: color } });
            });
            let option = getCommonOption('world', regions);
            myChart.setOption(option, true);
            myChart.off('click');
            myChart.on('click', params => {
                if (params.componentType === 'geo') {
                    if (params.name === 'China') renderChina();
                    else if (MAP_URLS[params.name]) renderForeign(params.name);
                    else alert(`æš‚æ—  [${CN_MAP[params.name]||params.name}] åœ°å›¾æ•°æ®`);
                }
            });
        });
    }

    function renderChina() {
        currentLevel = 'china';
        currentScopeName = 'China';
        updateBackButton(true, "â† è¿”å›ä¸–ç•Œ", renderWorld);
        document.getElementById('region-filter-btn').style.display = 'none';
        updateLogSidebar(null);
        myChart.showLoading();
        $.getJSON(`https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json`, function(geo) {
            myChart.hideLoading();
            echarts.registerMap('china', geo);
            let regions = [];
            geo.features.forEach(f => {
                let pName = f.properties.name;
                let count = new Set(travelData.filter(r => r.country === 'China' && r.province === pName).map(r => r.city)).size;
                let color = getHeatColor(count);
                if (baseCities.includes(pName)) color = '#FF8C00';
                if(color) regions.push({ name: pName, itemStyle: { areaColor: color } });
            });
            myChart.setOption(getCommonOption('china', regions), true);
            myChart.off('click');
            myChart.on('click', params => {
                if (params.componentType === 'geo') {
                    if (NO_DRILL_LIST.includes(params.name)) {
                        let coord = myChart.convertFromPixel('geo', [params.event.offsetX, params.event.offsetY]);
                        openDirectCityModal('China', params.name, coord);
                    } else {
                        let code = CHINA_PROVINCES[params.name];
                        if(code) renderProvince(params.name, code);
                    }
                }
            });
        });
    }

    function renderProvince(pName, adcode) {
        currentLevel = 'province';
        currentScopeName = pName;
        updateBackButton(true, "â† è¿”å›ä¸­å›½", renderChina);
        const filterBtn = document.getElementById('region-filter-btn');
        filterBtn.style.display = 'flex';
        filterBtn.onclick = function() { updateLogSidebar({ country: 'China', province: pName }); document.getElementById('sidebar').classList.add('open'); };

        myChart.showLoading();
        $.getJSON(`https://geo.datav.aliyun.com/areas_v3/bound/${adcode}_full.json`, function(geo) {
            myChart.hideLoading();
            echarts.registerMap(pName, geo);
            let regions = [];
            let points = [];
            geo.features.forEach(f => {
                let city = f.properties.name;
                let itemStyle = null;
                if (baseCities.includes(city)) itemStyle = { areaColor: '#FF8C00', shadowBlur: 10, shadowColor: '#FF8C00' };
                let recs = travelData.filter(r => r.country === 'China' && r.province === pName && r.city === city);
                if (recs.length > 0) {
                    if (!itemStyle) itemStyle = { areaColor: '#FFD700', shadowBlur: 10, shadowColor: '#FFD700' };
                    recs.forEach(r => points.push({ name: r.city, value: [r.lng, r.lat], custom: r }));
                }
                if (itemStyle) regions.push({ name: city, itemStyle: itemStyle });
            });
            let series = [{
                type: 'scatter', coordinateSystem: 'geo', data: points,
                symbol: 'circle', symbolSize: 12,
                itemStyle: { color: '#ff3333', shadowBlur: 10, shadowColor: '#ff0000', borderColor:'#fff' }
            }];
            let opt = getCommonOption(pName, regions, series);
            opt.geo.label.show = true;
            myChart.setOption(opt, true);
            setupClickEvent('China', pName);
        });
    }

    function renderForeign(cName) {
        currentLevel = 'foreign';
        currentScopeName = cName;
        updateBackButton(true, "â† è¿”å›ä¸–ç•Œ", renderWorld);
        const filterBtn = document.getElementById('region-filter-btn');
        filterBtn.style.display = 'flex';
        filterBtn.onclick = function() { updateLogSidebar({ country: cName }); document.getElementById('sidebar').classList.add('open'); };

        myChart.showLoading();
        $.getJSON(MAP_URLS[cName], function(geo) {
            myChart.hideLoading();
            echarts.registerMap(cName, geo);
            let regions = [];
            let points = [];
            geo.features.forEach(f => {
                let state = f.properties.name;
                let recs = travelData.filter(r => r.country === cName && r.province === state);
                if (recs.length > 0) {
                    regions.push({ name: state, itemStyle: { areaColor: 'rgba(255, 215, 0, 0.4)' } });
                    recs.forEach(r => points.push({ name: r.province, value: [r.lng, r.lat], custom: r }));
                }
            });
            let series = [{
                type: 'scatter', coordinateSystem: 'geo', data: points,
                symbol: 'circle', symbolSize: 12,
                itemStyle: { color: '#ff3333', shadowBlur: 10, shadowColor: '#ff0000', borderColor:'#fff' }
            }];
            myChart.setOption(getCommonOption(cName, regions, series), true);
            setupClickEvent(cName, null);
        });
    }

    function getCommonOption(mapName, regions, series = []) {
        const isWorld = mapName === 'world';
        return {
            backgroundColor: 'rgba(0,0,0,0)',
            tooltip: {
                trigger: 'item', backgroundColor: 'rgba(0,10,20,0.9)', borderColor: '#00dfff', textStyle: { color: '#fff' },
                formatter: params => {
                    if (params.componentType === 'series') {
                        const d = params.data.custom;
                        let tagsStr = d.tags && d.tags.length ? `<br>æ ‡ç­¾: <span style="color:#00dfff">${d.tags.join(', ')}</span>` : '';
                        return `<b>${params.data.name}</b><br>${d.date}${tagsStr}<br>${d.note}`;
                    }
                    return CN_MAP[params.name] || params.name;
                }
            },
            geo: {
                map: mapName, roam: true, aspectScale: 0.75, layoutCenter: ['50%', '50%'], layoutSize: '100%',
                label: {
                    show: true, color: '#fff', fontSize: 10, textShadowColor: '#000', textShadowBlur: 2,
                    formatter: p => isWorld ? (CN_MAP[p.name] ? CN_MAP[p.name] : "") : p.name
                },
                itemStyle: {
                    areaColor: '#1a2b3c', borderColor: '#4facfe', borderWidth: 0.6,
                    shadowColor: 'rgba(0, 223, 255, 0.4)', shadowBlur: 10
                },
                emphasis: { itemStyle: { areaColor: '#00dfff', shadowBlur: 20 }, label: { show: true, color: '#000' } },
                select: { disabled: true },
                regions: regions
            },
            series: series
        };
    }

    function setupClickEvent(country, fixedProvince) {
        myChart.off('click');
        myChart.on('click', params => {
            if (params.componentType === 'geo') {
                let coord = myChart.convertFromPixel('geo', [params.event.offsetX, params.event.offsetY]);
                tempClickData = {
                    country: country, province: fixedProvince || params.name,
                    city: fixedProvince ? params.name : '', lng: coord[0], lat: coord[1]
                };
                let cnC = CN_MAP[country] || country;
                let loc = cnC + (tempClickData.city ? ` Â· ${tempClickData.province} Â· ${tempClickData.city}` : ` Â· ${tempClickData.province}`);
                document.getElementById('loc-display').value = loc;
                document.getElementById('input-date').valueAsDate = new Date();
                document.getElementById('input-days').value = 1;
                document.getElementById('input-note').value = '';
                document.getElementById('input-distance').value = ''; document.getElementById('input-climb').value = ''; 
                document.getElementById('input-dives').value = ''; document.getElementById('input-ski-dist').value = '';
                document.getElementById('data-hike-run').classList.remove('active'); document.getElementById('data-dive').classList.remove('active'); document.getElementById('data-ski').classList.remove('active');
                editingIndex = null;
                document.getElementById('btn-delete').style.display = 'none';
                
                const tagArea = document.getElementById('tag-selector-area');
                tagArea.innerHTML = '';
                userTags.forEach(tag => {
                    let span = document.createElement('span');
                    span.className = 'tag-option';
                    span.innerText = tag;
                    span.onclick = function() { this.classList.toggle('selected'); checkDynamicInputs(); };
                    tagArea.appendChild(span);
                });
                document.getElementById('modal-mask').style.display = 'block';
            }
        });
    }

    function editRecord(index) {
        const r = travelData[index];
        editingIndex = index;
        tempClickData = { country: r.country, province: r.province, city: r.city, lng: r.lng, lat: r.lat };
        let cnC = CN_MAP[r.country] || r.country;
        let loc = cnC + (r.city ? ` Â· ${r.province} Â· ${r.city}` : ` Â· ${r.province}`);
        document.getElementById('loc-display').value = loc + " (ç¼–è¾‘)";
        document.getElementById('input-date').value = r.date;
        document.getElementById('input-days').value = r.days || 1;
        document.getElementById('input-note').value = r.note || '';
        document.getElementById('input-distance').value = r.distance || '';
        document.getElementById('input-climb').value = r.climb || '';
        document.getElementById('input-dives').value = r.dives || '';
        document.getElementById('input-ski-dist').value = r.skiDist || '';
        
        document.getElementById('btn-delete').style.display = 'inline-block';
        const tagArea = document.getElementById('tag-selector-area');
        tagArea.innerHTML = '';
        userTags.forEach(tag => {
            let span = document.createElement('span');
            span.className = 'tag-option';
            span.innerText = tag;
            if (r.tags && r.tags.includes(tag)) span.classList.add('selected');
            span.onclick = function() { this.classList.toggle('selected'); checkDynamicInputs(); };
            tagArea.appendChild(span);
        });
        checkDynamicInputs();
        document.getElementById('modal-mask').style.display = 'block';
    }

    function saveRecord() {
        const date = document.getElementById('input-date').value;
        const note = document.getElementById('input-note').value;
        const days = parseInt(document.getElementById('input-days').value) || 1;
        const dist = document.getElementById('input-distance').value;
        const climb = document.getElementById('input-climb').value;
        const dives = document.getElementById('input-dives').value;
        const skiDist = document.getElementById('input-ski-dist').value;
        
        let selectedTags = [];
        document.querySelectorAll('.tag-option.selected').forEach(el => selectedTags.push(el.innerText));

        const recordObj = { 
            ...tempClickData, date, days, note, tags: selectedTags,
            distance: dist, climb: climb, dives: dives, skiDist: skiDist
        };

        if (editingIndex !== null) travelData[editingIndex] = recordObj;
        else travelData.push(recordObj);

        localStorage.setItem(DATA_KEY, JSON.stringify(travelData));
        saveToCloud(); 
        closeModal();
        updateLogSidebar();
        updateStats();
        if (currentLevel === 'province') renderProvince(currentScopeName, CHINA_PROVINCES[currentScopeName]);
        else if (currentLevel === 'foreign') renderForeign(currentScopeName);
        else if (currentLevel === 'world') renderWorld();
        else renderChina();
    }

    function deleteRecord() {
        if (editingIndex === null) return;
        if (!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
        travelData.splice(editingIndex, 1);
        localStorage.setItem(DATA_KEY, JSON.stringify(travelData));
        saveToCloud();
        closeModal();
        updateLogSidebar();
        updateStats();
        if (currentLevel === 'province') renderProvince(currentScopeName, CHINA_PROVINCES[currentScopeName]);
        else if (currentLevel === 'foreign') renderForeign(currentScopeName);
        else if (currentLevel === 'world') renderWorld();
        else renderChina();
    }

    // è¾…åŠ©é€»è¾‘
    function checkDynamicInputs() {
        let selectedTags = [];
        document.querySelectorAll('.tag-option.selected').forEach(el => selectedTags.push(el.innerText));
        const tStr = selectedTags.join(',');

        const divHike = document.getElementById('data-hike-run');
        const divDive = document.getElementById('data-dive');
        const divSki = document.getElementById('data-ski');

        if (divHike) {
            if (tStr.includes('å¾’æ­¥') || tStr.includes('è¶Šé‡è·‘')) divHike.classList.add('active'); 
            else divHike.classList.remove('active');
        }
        if (divDive) {
            if (tStr.includes('æ½œæ°´')) divDive.classList.add('active'); 
            else divDive.classList.remove('active');
        }
        if (divSki) {
            if (tStr.includes('æ»‘é›ª')) divSki.classList.add('active'); 
            else divSki.classList.remove('active');
        }
    }
    
    function closeModal() { document.getElementById('modal-mask').style.display = 'none'; }
    
    function updateBackButton(show, text, handler) { 
        const btn = document.getElementById('nav-back-btn'); 
        if (show) { 
            btn.style.display = 'flex'; 
            btn.innerText = text; 
            btn.onclick = handler; 
        } else { 
            btn.style.display = 'none'; 
        } 
    }

    function getHeatColor(count) { 
        if(count >= 3) return 'rgba(255, 215, 0, 1.0)'; 
        if(count === 2) return 'rgba(255, 215, 0, 0.6)'; 
        if(count === 1) return 'rgba(255, 215, 0, 0.3)'; 
        return null; 
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    
    function toggleEditMode() { 
        document.getElementById('sidebar').classList.toggle('edit-mode'); 
        document.querySelector('.sidebar-edit-toggle').classList.toggle('active');
    }

    function updateStats() {
        document.getElementById('count-country').innerText = new Set(travelData.map(r => r.country)).size;
        document.getElementById('count-total').innerText = travelData.length;
    }

    // --- æ ‡ç­¾ç®¡ç†é€»è¾‘ ---
    function openTagManager() {
        const listDiv = document.getElementById('manage-tag-list');
        listDiv.innerHTML = '';
        userTags.forEach((tag, index) => {
            let item = document.createElement('div');
            item.className = 'manage-tag-item';
            item.innerHTML = `<span>${tag}</span> <span class="btn-del-tag" onclick="deleteTag(${index})">åˆ é™¤</span>`;
            listDiv.appendChild(item);
        });
        document.getElementById('tag-manager-mask').style.display = 'block';
    }
    
    function closeTagManager() { document.getElementById('tag-manager-mask').style.display = 'none'; }
    
    function addNewTag() {
        const val = document.getElementById('new-tag-name').value.trim();
        if(val && !userTags.includes(val)) {
            userTags.push(val); 
            localStorage.setItem(TAGS_KEY, JSON.stringify(userTags));
saveToCloud(); 
            document.getElementById('new-tag-name').value = ''; 
            openTagManager();
        }
    }
    
    function deleteTag(index) {
        if(confirm('åˆ é™¤æ­¤æ ‡ç­¾ï¼Ÿ')) { 
            userTags.splice(index, 1); 
            localStorage.setItem(TAGS_KEY, JSON.stringify(userTags)); 
saveToCloud(); 
            openTagManager(); 
        }
    }

    // --- Baseåœ°ç®¡ç†é€»è¾‘ ---
    function openBaseManager() {
        const listDiv = document.getElementById('manage-base-list');
        listDiv.innerHTML = '';
        baseCities.forEach((city, index) => {
            let item = document.createElement('div');
            item.className = 'manage-tag-item';
            item.innerHTML = `<span style="color:#FF8C00">${city}</span> <span class="btn-del-tag" onclick="deleteBase(${index})">åˆ é™¤</span>`;
            listDiv.appendChild(item);
        });
        document.getElementById('base-manager-mask').style.display = 'block';
    }
    
    function closeBaseManager() { 
        document.getElementById('base-manager-mask').style.display = 'none'; 
        // åˆ·æ–°å½“å‰åœ°å›¾ä»¥æ›´æ–°é¢œè‰²
        if (currentLevel === 'china') renderChina();
        else if (currentLevel === 'province') renderProvince(currentScopeName, CHINA_PROVINCES[currentScopeName]);
    }
    
    function addNewBase() {
        const val = document.getElementById('new-base-name').value.trim();
        if(val && !baseCities.includes(val)) {
            baseCities.push(val); 
            localStorage.setItem(BASE_KEY, JSON.stringify(baseCities));
saveToCloud(); 
            document.getElementById('new-base-name').value = ''; 
            openBaseManager();
        }
    }
    
    function deleteBase(index) {
        if(confirm('ç§»é™¤æ­¤Baseåœ°ï¼Ÿ')) { 
            baseCities.splice(index, 1); 
            localStorage.setItem(BASE_KEY, JSON.stringify(baseCities)); 
saveToCloud(); 
            openBaseManager(); 
        }
    }

    // --- ç›´è¾–å¸‚/æ¸¯æ¾³ ç‚¹å‡»é€»è¾‘ ---
    function openDirectCityModal(country, cityName, coord) {
        tempClickData = {
            country: country, province: cityName, city: cityName, lng: coord[0], lat: coord[1]
        };
        let loc = `${CN_MAP[country]} ${cityName}`;
        document.getElementById('loc-display').value = loc;
        document.getElementById('input-date').valueAsDate = new Date();
        document.getElementById('input-days').value = 1;
        document.getElementById('input-note').value = '';
        // é‡ç½®åŠ¨æ€æ•°æ®
        document.getElementById('input-distance').value = ''; document.getElementById('input-climb').value = ''; 
        document.getElementById('input-dives').value = ''; document.getElementById('input-ski-dist').value = '';
        document.getElementById('data-hike-run').classList.remove('active'); document.getElementById('data-dive').classList.remove('active'); document.getElementById('data-ski').classList.remove('active');
        
        editingIndex = null;
        document.getElementById('btn-delete').style.display = 'none';

        const tagArea = document.getElementById('tag-selector-area');
        tagArea.innerHTML = '';
        userTags.forEach(tag => {
            let span = document.createElement('span');
            span.className = 'tag-option';
            span.innerText = tag;
            span.onclick = function() { this.classList.toggle('selected'); checkDynamicInputs(); };
            tagArea.appendChild(span);
        });
        document.getElementById('modal-mask').style.display = 'block';
    }

    // --- æ•°æ®å¤‡ä»½ä¸æ¢å¤ ---
    function exportData() {
        if (travelData.length === 0 && userTags.length === 0) { alert("æš‚æ— æ•°æ®"); return; }
        const backup = { version: "3.8", timestamp: new Date().toLocaleString(), data: travelData, tags: userTags, bases: baseCities };
        const blob = new Blob([JSON.stringify(backup)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `travel_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (!json.data) throw new Error("æ ¼å¼é”™è¯¯");
                if (!confirm(`è¦†ç›–å½“å‰æ•°æ®ï¼Ÿ\nè®°å½•æ•°: ${json.data.length}`)) return;
                travelData = json.data;
                userTags = json.tags || userTags;
                baseCities = json.bases || [];
                localStorage.setItem(DATA_KEY, JSON.stringify(travelData));
                localStorage.setItem(TAGS_KEY, JSON.stringify(userTags));
                localStorage.setItem(BASE_KEY, JSON.stringify(baseCities));
                location.reload();
            } catch (err) { alert("å¯¼å…¥å¤±è´¥: " + err.message); }
        };
        reader.readAsText(file);
    }
// --- è®¤è¯ä¸åŒæ­¥é€»è¾‘ ---

    // 1. æ³¨å†Œ
    async function handleSignUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if(!email || !password) return alert("è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ");
        
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) {
            document.getElementById('login-msg').innerText = error.message;
        } else {
            alert("æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±å®ŒæˆéªŒè¯ï¼Œæˆ–ç›´æ¥ç™»å½•ï¼ˆè§†Supabaseè®¾ç½®è€Œå®šï¼‰ã€‚");
            handleLogin(); // å°è¯•è‡ªåŠ¨ç™»å½•
        }
    }

    // 2. ç™»å½•
    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
            document.getElementById('login-msg').innerText = error.message;
        } else {
            currentUser = data.user;
            initCloudData(); // ç™»å½•æˆåŠŸååŠ è½½æ•°æ®
        }
    }

    // 3. é€€å‡º
    async function handleLogout() {
        await supabase.auth.signOut();
        location.reload();
    }

    // 4. ç¦»çº¿æ¨¡å¼
    function useOfflineMode() {
        document.getElementById('login-mask').style.display = 'none';
        // ç¦»çº¿æ¨¡å¼é»˜è®¤è¯»å– LocalStorage (å·²æœ‰é€»è¾‘ä¼šè‡ªåŠ¨å¤„ç†)
    }

    // 5. åˆå§‹åŒ–äº‘ç«¯æ•°æ®
    async function initCloudData() {
        document.getElementById('login-mask').style.display = 'none';
        document.getElementById('user-status').style.display = 'block';
        document.getElementById('user-email').innerText = currentUser.email.split('@')[0];

        // ä»äº‘ç«¯æ‹‰å–æ•°æ®
        const { data, error } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();

        if (data) {
            // äº‘ç«¯æœ‰æ•°æ®ï¼šè¦†ç›–æœ¬åœ°å˜é‡ï¼ˆä½†ä¸è¦†ç›–LocalStorageï¼Œé™¤éä½ æƒ³åšç¼“å­˜ï¼‰
            // è¯¢é—®ç­–ç•¥ï¼šå¦‚æœæœ¬åœ°ä¹Ÿæœ‰æ•°æ®ï¼Œå¯ä»¥æç¤ºç”¨æˆ·æ˜¯å¦åˆå¹¶ï¼Œè¿™é‡Œç®€å•å¤„ç†ä¸ºâ€œä»¥äº‘ç«¯ä¸ºå‡†â€
            console.log("äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ");
            travelData = data.travel_data || [];
            userTags = data.tags || userTags;
            baseCities = data.bases || [];
        } else {
            // äº‘ç«¯æ— æ•°æ®ï¼ˆæ–°ç”¨æˆ·ï¼‰ï¼šå°†æœ¬åœ°ç°æœ‰æ•°æ®ä¸Šä¼ ä½œä¸ºåˆå§‹æ•°æ®
            console.log("æ–°ç”¨æˆ·ï¼Œä¸Šä¼ æœ¬åœ°æ•°æ®ä½œä¸ºåˆå§‹æ•°æ®");
            saveToCloud();
        }

        // åˆ·æ–°ç•Œé¢
        updateLogSidebar();
        updateStats();
        renderWorld();
    }

    // 6. ä¿å­˜åˆ°äº‘ç«¯ (æ›¿æ¢ LocalStorage)
    async function saveToCloud() {
        if (!currentUser) return; // æœªç™»å½•ä¸ä¸Šä¼ 

        const { error } = await supabase
            .from('user_profiles')
            .upsert({ 
                id: currentUser.id,
                travel_data: travelData,
                tags: userTags,
                bases: baseCities
            });
            
        if (error) console.error("ä¸Šä¼ å¤±è´¥:", error);
        else console.log("äº‘ç«¯åŒæ­¥æˆåŠŸ");
    }

    // --- å¯åŠ¨ä¸ç›‘å¬ ---
    window.addEventListener('resize', () => myChart.resize());
    
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä¼šè¯ (è‡ªåŠ¨ç™»å½•)
    supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            currentUser = session.user;
            initCloudData();
        } else {
            // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æ¡†ï¼Œä½†åœ¨åå°å…ˆæ¸²æŸ“ä¸€æ¬¡ç¦»çº¿æ•°æ®ä½œä¸ºèƒŒæ™¯
            renderWorld();
            updateLogSidebar();
            updateStats();
            document.getElementById('login-mask').style.display = 'flex';
        }
    });

</script>
</body>
</html>
